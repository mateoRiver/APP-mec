<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MECON Dashboard</title>
    
    <!-- Favicon y PWA -->
    <link rel="icon" type="image/png" href="mecon-logo.png">
    <link rel="apple-touch-icon" href="mecon-logo.png">
    <link rel="shortcut icon" href="mecon-logo.png">
    <meta name="theme-color" content="#0f172a">
    <meta name="msapplication-TileColor" content="#0f172a">
    <meta name="msapplication-TileImage" content="mecon-logo.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            max-width: 100vw;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: white;
            padding-bottom: 80px;
            overflow-x: hidden;
            max-width: 100vw;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            color: #0f172a;
            padding: 40px 30px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 8px;
            font-size: 32px;
            font-weight: 800;
        }

        .login-box p {
            text-align: center;
            margin-bottom: 32px;
            color: #64748b;
            font-size: 15px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .error-message {
            color: #ef4444;
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .dashboard {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px 12px;
        }

        .dashboard.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .date-filter {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: #cbd5e1;
        }

        .filter-group select {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
        }

        .filter-group select option {
            background: #1e293b;
            color: white;
        }

        .btn-filter {
            padding: 10px 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 28px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-card h3 {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ffffff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card .description {
            font-size: 14px;
            margin-bottom: 16px;
            opacity: 0.8;
            line-height: 1.5;
        }

        .stat-card .change {
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
        }

        .stat-card .change.positive {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .stat-card .change.negative {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .stat-card .change.neutral {
            background: rgba(148, 163, 184, 0.2);
            color: #cbd5e1;
        }

        .stat-card .view-more {
            margin-top: 16px;
            font-size: 13px;
            color: #60a5fa;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Estilos para tarjeta m√©trica BCRA */
        .bcra-metric-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .bcra-metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .bcra-metric-card:hover::before {
            transform: scaleX(1);
        }

        .bcra-metric-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .metric-item {
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .metric-label {
            font-size: 11px;
            font-weight: 600;
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .metric-date {
            font-size: 11px;
            opacity: 0.7;
        }

        .chart-detail {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 16px;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .chart-detail h2 {
            color: white;
            margin-bottom: 16px;
            font-size: 20px;
            font-weight: 700;
            line-height: 1.3;
        }

        .chart-wrapper {
            position: relative;
            height: 600px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 30px 20px 20px 20px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 24px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-4px);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            display: none;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 1000;
        }

        .bottom-nav.active {
            display: flex;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 20px;
            cursor: pointer;
            color: #94a3b8;
            transition: all 0.3s;
            border: none;
            background: none;
            font-family: 'Inter', sans-serif;
            position: relative;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 0 0 3px 3px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .nav-item.active::before {
            opacity: 1;
        }

        .nav-item.active {
            color: #3b82f6;
        }

        .nav-item .icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .nav-item .label {
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 22px; }
            .stat-card .value { font-size: 40px; }
            .chart-wrapper { height: 550px; padding: 16px 8px 8px 8px; }
            .stats-grid { grid-template-columns: 1fr; }
            .chart-detail { padding: 16px 12px; }
            .chart-detail h2 { font-size: 16px; margin-bottom: 8px; }
            .date-filter { 
                padding: 6px 10px; 
                margin-bottom: 6px; 
                gap: 8px;
                flex-wrap: wrap;
                align-items: flex-end;
            }
            .nav-item { padding: 8px 10px; }
            .nav-item .label { font-size: 10px; }
            .filter-group { 
                min-width: 110px; 
                flex: 1;
            }
            .filter-group label { font-size: 10px; margin-bottom: 3px; }
            .date-input { 
                font-size: 11px; 
                padding: 6px 6px;
                width: 100%;
                box-sizing: border-box;
            }
            .btn-filter { font-size: 12px; padding: 6px 12px; }
            .btn-primary { font-size: 10px !important; padding: 5px 10px !important; }
            .btn-primary span { font-size: 10px; }
        }

        @media (max-width: 480px) {
            .dashboard { 
                padding: 10px;
                overflow-x: hidden;
                max-width: 100%;
            }
            .stat-card { padding: 20px; }
            .chart-wrapper { height: 520px; padding: 12px 6px 6px 6px; }
            .chart-detail { padding: 12px 8px; }
            .section { 
                overflow-x: hidden;
                max-width: 100%;
            }
            .date-filter { 
                gap: 10px; 
                padding: 12px;
                flex-direction: column;
                align-items: stretch;
                max-width: 100%;
                box-sizing: border-box;
            }
            .filter-group { 
                width: 100%;
                max-width: 100%;
                flex: none;
                box-sizing: border-box;
            }
            .filter-group label { 
                font-size: 10px; 
                margin-bottom: 4px;
                display: block;
            }
            .date-input { 
                font-size: 12px; 
                padding: 8px 10px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            .btn-filter { 
                font-size: 13px; 
                padding: 10px 16px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            .btn-primary { font-size: 9px !important; padding: 4px 8px !important; }
            
            /* Header Datos BCRA en m√≥vil */
            #bcraSection > div:first-child {
                flex-wrap: wrap;
                gap: 10px;
            }
            #bcraSection > div:first-child h2 {
                font-size: 16px !important;
            }
            #bcraSection > div:first-child button {
                font-size: 11px !important;
                padding: 6px 12px !important;
            }
            
            /* Tarjeta m√©trica BCRA responsive */
            .bcra-metric-card {
                padding: 16px;
                max-width: 100%;
                box-sizing: border-box;
            }
            .bcra-metric-card h3 {
                font-size: 14px;
                margin-bottom: 12px;
            }
            .metric-item {
                padding: 8px;
            }
            .metric-label {
                font-size: 9px;
            }
            .metric-value {
                font-size: 20px;
            }
            .metric-date {
                font-size: 9px;
            }
        }
        
        /* Botones de rango de fechas */
        .rango-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .rango-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
        }
        
        .rango-btn.active {
            background: #667eea;
            border-color: #667eea;
        }
        
        /* Inputs de fecha */
        .date-input {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            width: 100%;
            box-sizing: border-box;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            -webkit-border-radius: 12px;
        }
        
        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        
        .date-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Loading Overlay con Bandera Argentina */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading-flag {
            width: 120px;
            height: 80px;
            position: relative;
            animation: wave 1.5s ease-in-out infinite;
        }
        
        .flag-stripe {
            width: 100%;
            height: 33.33%;
        }
        
        .flag-celeste {
            background: #75AADB;
        }
        
        .flag-blanca {
            background: #FFFFFF;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .flag-sol {
            width: 24px;
            height: 24px;
            background: #F6B40E;
            border-radius: 50%;
            position: relative;
        }
        
        .flag-sol::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #F6B40E 40%, transparent 40%);
            animation: rotate 2s linear infinite;
        }
        
        @keyframes wave {
            0%, 100% { transform: perspective(400px) rotateY(-15deg); }
            50% { transform: perspective(400px) rotateY(15deg); }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            color: #cbd5e1;
            font-size: 16px;
            font-weight: 500;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
    </style>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- SheetJS para leer Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>MECON</h1>
            <p>Datos Oficiales</p>
            <div class="input-group">
                <label for="username">Usuario</label>
                <input type="text" id="username" placeholder="Ingrese su usuario">
            </div>
            <div class="input-group">
                <label for="password">Contrase√±a</label>
                <input type="password" id="password" placeholder="Ingrese su contrase√±a">
            </div>
            <button class="login-btn" onclick="login()">Ingresar</button>
            <div class="error-message" id="errorMessage">Usuario o contrase√±a incorrectos</div>
        </div>
    </div>

    <div id="dashboard" class="dashboard">
        <div class="header">
            <h1>MECON Dashboard</h1>
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="descargarExcel()">
                    <span>üì•</span><span>Descargar Excel</span>
                </button>
                <button class="btn btn-secondary" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div id="ipc-emaeSection" class="section active">
            <div class="stats-grid">
                <div class="stat-card" onclick="showSection('mensual')">
                    <h3>Inflaci√≥n Enero 2026</h3>
                    <div class="value">2.9%</div>
                    <div class="description">√öltimo dato mensual</div>
                    <div class="view-more">Ver gr√°fico ‚Üí</div>
                </div>
                <div class="stat-card" onclick="showSection('interanual')">
                    <h3>Inflaci√≥n Interanual</h3>
                    <div class="value">32.4%</div>
                    <div class="description">Ene 2026 vs Ene 2025</div>
                    <div class="view-more">Ver gr√°fico ‚Üí</div>
                </div>
                <div class="stat-card" onclick="showSection('emae')">
                    <h3>EMAE Noviembre 2025</h3>
                    <div class="value">152.4</div>
                    <div class="description">Desestacionalizado</div>
                    <div class="change neutral">Base 2004=100</div>
                    <div class="view-more">Ver gr√°fico ‚Üí</div>
                </div>
            </div>
        </div>

        <div id="mensualSection" class="section">
            <button class="back-btn" onclick="showSection('ipc-emae')">‚Üê Volver</button>
            <div class="date-filter">
                <div class="filter-group">
                    <label>Desde</label>
                    <select id="fechaDesde"></select>
                </div>
                <div class="filter-group">
                    <label>Hasta</label>
                    <select id="fechaHasta"></select>
                </div>
                <button class="btn-filter" onclick="aplicarFiltroMensual()">Aplicar</button>
            </div>
            <div class="chart-detail">
                <h2>Inflaci√≥n Mensual y EMAE</h2>
                <div class="chart-wrapper">
                    <canvas id="inflacionMensualChart"></canvas>
                </div>
            </div>
        </div>

        <div id="interanualSection" class="section">
            <button class="back-btn" onclick="showSection('ipc-emae')">‚Üê Volver</button>
            <div class="date-filter">
                <div class="filter-group">
                    <label>Desde</label>
                    <select id="fechaDesdeInteranual"></select>
                </div>
                <div class="filter-group">
                    <label>Hasta</label>
                    <select id="fechaHastaInteranual"></select>
                </div>
                <button class="btn-filter" onclick="aplicarFiltroInteranual()">Aplicar</button>
            </div>
            <div class="chart-detail">
                <h2>Inflaci√≥n Interanual Mensual</h2>
                <div class="chart-wrapper">
                    <canvas id="inflacionInteranualChart"></canvas>
                </div>
            </div>
        </div>

        <div id="emaeSection" class="section">
            <button class="back-btn" onclick="showSection('ipc-emae')">‚Üê Volver</button>
            <div class="date-filter">
                <div class="filter-group">
                    <label>Desde</label>
                    <select id="fechaDesdeEmae"></select>
                </div>
                <div class="filter-group">
                    <label>Hasta</label>
                    <select id="fechaHastaEmae"></select>
                </div>
                <button class="btn-filter" onclick="aplicarFiltroEmae()">Aplicar</button>
            </div>
            <div class="chart-detail">
                <h2>EMAE Desestacionalizado (Base 2004=100)</h2>
                <div class="chart-wrapper">
                    <canvas id="emaeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN BCRA - RESUMEN -->
        <div id="bcraSection" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h2 style="margin: 0; font-size: 20px; color: #cbd5e1;">Datos BCRA</h2>
                <button class="btn btn-primary" onclick="mostrarModalUpload()" style="padding: 8px 16px; font-size: 13px;">
                    <span>üì•</span><span>Actualizar Datos</span>
                </button>
            </div>
            
            <div class="date-filter">
                <div class="filter-group">
                    <label>Desde</label>
                    <input type="date" id="fechaDesdeBCRAResumen" class="date-input">
                </div>
                <div class="filter-group">
                    <label>Hasta</label>
                    <input type="date" id="fechaHastaBCRAResumen" class="date-input">
                </div>
                <button class="btn-filter" onclick="aplicarFiltroResumenBCRA()">Aplicar</button>
            </div>
            
            <!-- Bot√≥n Base Monetaria con estad√≠sticas dentro -->
            <div class="bcra-metric-card" onclick="showSection('bcra-bm')">
                <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #cbd5e1;">Base Monetaria (% PBI)</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                    <div class="metric-item">
                        <div class="metric-label">Primer Dato</div>
                        <div class="metric-value" id="bm-primero">-</div>
                        <div class="metric-date" id="bm-primero-fecha">-</div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="metric-label">√öltimo Dato</div>
                        <div class="metric-value" id="bm-ultimo">-</div>
                        <div class="metric-date" id="bm-ultimo-fecha">-</div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="metric-label">Promedio</div>
                        <div class="metric-value" id="bm-promedio">-</div>
                        <div class="metric-date">Del per√≠odo</div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="metric-label">M√°ximo</div>
                        <div class="metric-value" id="bm-maximo">-</div>
                        <div class="metric-date" id="bm-maximo-fecha">-</div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="metric-label">M√≠nimo</div>
                        <div class="metric-value" id="bm-minimo">-</div>
                        <div class="metric-date" id="bm-minimo-fecha">-</div>
                    </div>
                </div>
                
                <div class="view-more" style="margin-top: 16px;">Ver gr√°fico ‚Üí</div>
            </div>
            
            <!-- Bot√≥n Dep√≥sitos Totales -->
            <div class="bcra-metric-card" onclick="showSection('bcra-depositos')">
                <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #cbd5e1;">Dep√≥sitos Totales Sector Privado (% PBI)</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                    <div class="metric-item">
                        <div class="metric-label">Primer Dato</div>
                        <div class="metric-value" id="dep-primero">-</div>
                        <div class="metric-date" id="dep-primero-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">√öltimo Dato</div>
                        <div class="metric-value" id="dep-ultimo">-</div>
                        <div class="metric-date" id="dep-ultimo-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Promedio</div>
                        <div class="metric-value" id="dep-promedio">-</div>
                        <div class="metric-date">Del per√≠odo</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">M√°ximo</div>
                        <div class="metric-value" id="dep-maximo">-</div>
                        <div class="metric-date" id="dep-maximo-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">M√≠nimo</div>
                        <div class="metric-value" id="dep-minimo">-</div>
                        <div class="metric-date" id="dep-minimo-fecha">-</div>
                    </div>
                </div>
                
                <div class="view-more" style="margin-top: 16px;">Ver gr√°fico ‚Üí</div>
            </div>
            
            <!-- Bot√≥n M2 Transaccional -->
            <div class="bcra-metric-card" onclick="showSection('bcra-m2')">
                <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #cbd5e1;">M2 Transaccional Sector Privado (% PBI)</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                    <div class="metric-item">
                        <div class="metric-label">Primer Dato</div>
                        <div class="metric-value" id="m2-primero">-</div>
                        <div class="metric-date" id="m2-primero-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">√öltimo Dato</div>
                        <div class="metric-value" id="m2-ultimo">-</div>
                        <div class="metric-date" id="m2-ultimo-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Promedio</div>
                        <div class="metric-value" id="m2-promedio">-</div>
                        <div class="metric-date">Del per√≠odo</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">M√°ximo</div>
                        <div class="metric-value" id="m2-maximo">-</div>
                        <div class="metric-date" id="m2-maximo-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">M√≠nimo</div>
                        <div class="metric-value" id="m2-minimo">-</div>
                        <div class="metric-date" id="m2-minimo-fecha">-</div>
                    </div>
                </div>
                
                <div class="view-more" style="margin-top: 16px;">Ver gr√°fico ‚Üí</div>
            </div>
            
            <!-- Bot√≥n Pr√©stamos en Pesos -->
            <div class="bcra-metric-card" onclick="showSection('bcra-prestamos-pesos')">
                <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #cbd5e1;">Pr√©stamos en Pesos Sector Privado (% PBI)</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                    <div class="metric-item">
                        <div class="metric-label">Primer Dato</div>
                        <div class="metric-value" id="pp-primero">-</div>
                        <div class="metric-date" id="pp-primero-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">√öltimo Dato</div>
                        <div class="metric-value" id="pp-ultimo">-</div>
                        <div class="metric-date" id="pp-ultimo-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Promedio</div>
                        <div class="metric-value" id="pp-promedio">-</div>
                        <div class="metric-date">Del per√≠odo</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">M√°ximo</div>
                        <div class="metric-value" id="pp-maximo">-</div>
                        <div class="metric-date" id="pp-maximo-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">M√≠nimo</div>
                        <div class="metric-value" id="pp-minimo">-</div>
                        <div class="metric-date" id="pp-minimo-fecha">-</div>
                    </div>
                </div>
                
                <div class="view-more" style="margin-top: 16px;">Ver gr√°fico ‚Üí</div>
            </div>
            
            <!-- Bot√≥n Pr√©stamos en D√≥lares -->
            <div class="bcra-metric-card" onclick="showSection('bcra-prestamos-dolares')">
                <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #cbd5e1;">Pr√©stamos en D√≥lares Sector Privado (% PBI)</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                    <div class="metric-item">
                        <div class="metric-label">Primer Dato</div>
                        <div class="metric-value" id="pd-primero">-</div>
                        <div class="metric-date" id="pd-primero-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">√öltimo Dato</div>
                        <div class="metric-value" id="pd-ultimo">-</div>
                        <div class="metric-date" id="pd-ultimo-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Promedio</div>
                        <div class="metric-value" id="pd-promedio">-</div>
                        <div class="metric-date">Del per√≠odo</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">M√°ximo</div>
                        <div class="metric-value" id="pd-maximo">-</div>
                        <div class="metric-date" id="pd-maximo-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">M√≠nimo</div>
                        <div class="metric-value" id="pd-minimo">-</div>
                        <div class="metric-date" id="pd-minimo-fecha">-</div>
                    </div>
                </div>
                
                <div class="view-more" style="margin-top: 16px;">Ver gr√°fico ‚Üí</div>
            </div>
            
            <!-- Bot√≥n Pr√©stamos Totales -->
            <div class="bcra-metric-card" onclick="showSection('bcra-prestamos-totales')">
                <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #cbd5e1;">Pr√©stamos Totales Sector Privado (% PBI)</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                    <div class="metric-item">
                        <div class="metric-label">Primer Dato</div>
                        <div class="metric-value" id="pt-primero">-</div>
                        <div class="metric-date" id="pt-primero-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">√öltimo Dato</div>
                        <div class="metric-value" id="pt-ultimo">-</div>
                        <div class="metric-date" id="pt-ultimo-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Promedio</div>
                        <div class="metric-value" id="pt-promedio">-</div>
                        <div class="metric-date">Del per√≠odo</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">M√°ximo</div>
                        <div class="metric-value" id="pt-maximo">-</div>
                        <div class="metric-date" id="pt-maximo-fecha">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">M√≠nimo</div>
                        <div class="metric-value" id="pt-minimo">-</div>
                        <div class="metric-date" id="pt-minimo-fecha">-</div>
                    </div>
                </div>
                
                <div class="view-more" style="margin-top: 16px;">Ver gr√°fico ‚Üí</div>
            </div>
        </div>

        <!-- SECCI√ìN BCRA - GR√ÅFICO -->
        <div id="bcra-bmSection" class="section">
            <button class="back-btn" onclick="showSection('bcra')">‚Üê Volver</button>
            
            <div class="date-filter">
                <div class="filter-group">
                    <label>Desde</label>
                    <input type="date" id="fechaDesdeBCRA" class="date-input">
                </div>
                <div class="filter-group">
                    <label>Hasta</label>
                    <input type="date" id="fechaHastaBCRA" class="date-input">
                </div>
                <button class="btn-filter" onclick="aplicarFiltroBCRA()">Aplicar</button>
            </div>
            
            <div class="chart-detail">
                <h2>Base Monetaria (% PBI)</h2>
                <div class="chart-wrapper">
                    <canvas id="chartBM"></canvas>
                </div>
                
                <p style="font-size: 12px; opacity: 0.6; margin-top: 12px; text-align: center;" id="lastUpdateBCRA">
                    Sin datos cargados
                </p>
            </div>
        </div>

        <!-- SECCI√ìN BCRA - GR√ÅFICO DEP√ìSITOS TOTALES -->
        <div id="bcra-depositosSection" class="section">
            <button class="back-btn" onclick="showSection('bcra')">‚Üê Volver</button>
            
            <div class="date-filter">
                <div class="filter-group">
                    <label>Desde</label>
                    <input type="date" id="fechaDesdeDEP" class="date-input">
                </div>
                <div class="filter-group">
                    <label>Hasta</label>
                    <input type="date" id="fechaHastaDEP" class="date-input">
                </div>
                <button class="btn-filter" onclick="aplicarFiltroDEP()">Aplicar</button>
            </div>
            
            <div class="chart-detail">
                <h2>Dep√≥sitos Totales Sector Privado (% PBI)</h2>
                <div class="chart-wrapper">
                    <canvas id="chartDEP"></canvas>
                </div>
                
                <p style="font-size: 12px; opacity: 0.6; margin-top: 12px; text-align: center;" id="lastUpdateDEP">
                    Sin datos cargados
                </p>
            </div>
        </div>

        <!-- SECCI√ìN M2 TRANSACCIONAL -->
        <div id="bcra-m2Section" class="section">
            <button class="back-btn" onclick="showSection('bcra')">‚Üê Volver</button>
            
            <div class="date-filter">
                <div class="filter-group">
                    <label>Desde</label>
                    <input type="date" id="fechaDesdeM2" class="date-input">
                </div>
                <div class="filter-group">
                    <label>Hasta</label>
                    <input type="date" id="fechaHastaM2" class="date-input">
                </div>
                <button class="btn-filter" onclick="aplicarFiltroM2()">Aplicar</button>
            </div>
            
            <div class="chart-detail">
                <h2>M2 Transaccional Sector Privado (% PBI)</h2>
                <div class="chart-wrapper">
                    <canvas id="chartM2"></canvas>
                </div>
                
                <p style="font-size: 12px; opacity: 0.6; margin-top: 12px; text-align: center;" id="lastUpdateM2">
                    Sin datos cargados
                </p>
            </div>
        </div>

        <!-- SECCI√ìN PR√âSTAMOS EN PESOS -->
        <div id="bcra-prestamos-pesosSection" class="section">
            <button class="back-btn" onclick="showSection('bcra')">‚Üê Volver</button>
            
            <div class="date-filter">
                <div class="filter-group">
                    <label>Desde</label>
                    <input type="date" id="fechaDesdePrestPesos" class="date-input">
                </div>
                <div class="filter-group">
                    <label>Hasta</label>
                    <input type="date" id="fechaHastaPrestPesos" class="date-input">
                </div>
                <button class="btn-filter" onclick="aplicarFiltroPrestPesos()">Aplicar</button>
            </div>
            
            <div class="chart-detail">
                <h2>Pr√©stamos en Pesos Sector Privado (% PBI)</h2>
                <div class="chart-wrapper">
                    <canvas id="chartPrestPesos"></canvas>
                </div>
                
                <p style="font-size: 12px; opacity: 0.6; margin-top: 12px; text-align: center;" id="lastUpdatePrestPesos">
                    Sin datos cargados
                </p>
            </div>
        </div>

        <!-- SECCI√ìN PR√âSTAMOS EN D√ìLARES -->
        <div id="bcra-prestamos-dolaresSection" class="section">
            <button class="back-btn" onclick="showSection('bcra')">‚Üê Volver</button>
            
            <div class="date-filter">
                <div class="filter-group">
                    <label>Desde</label>
                    <input type="date" id="fechaDesdePrestDolares" class="date-input">
                </div>
                <div class="filter-group">
                    <label>Hasta</label>
                    <input type="date" id="fechaHastaPrestDolares" class="date-input">
                </div>
                <button class="btn-filter" onclick="aplicarFiltroPrestDolares()">Aplicar</button>
            </div>
            
            <div class="chart-detail">
                <h2>Pr√©stamos en D√≥lares Sector Privado (% PBI)</h2>
                <div class="chart-wrapper">
                    <canvas id="chartPrestDolares"></canvas>
                </div>
                
                <p style="font-size: 12px; opacity: 0.6; margin-top: 12px; text-align: center;" id="lastUpdatePrestDolares">
                    Sin datos cargados
                </p>
            </div>
        </div>

        <!-- SECCI√ìN PR√âSTAMOS TOTALES -->
        <div id="bcra-prestamos-totalesSection" class="section">
            <button class="back-btn" onclick="showSection('bcra')">‚Üê Volver</button>
            
            <div class="date-filter">
                <div class="filter-group">
                    <label>Desde</label>
                    <input type="date" id="fechaDesdePrestTotales" class="date-input">
                </div>
                <div class="filter-group">
                    <label>Hasta</label>
                    <input type="date" id="fechaHastaPrestTotales" class="date-input">
                </div>
                <button class="btn-filter" onclick="aplicarFiltroPrestTotales()">Aplicar</button>
            </div>
            
            <div class="chart-detail">
                <h2>Pr√©stamos Totales Sector Privado (% PBI)</h2>
                <div class="chart-wrapper">
                    <canvas id="chartPrestTotales"></canvas>
                </div>
                
                <p style="font-size: 12px; opacity: 0.6; margin-top: 12px; text-align: center;" id="lastUpdatePrestTotales">
                    Sin datos cargados
                </p>
            </div>
        </div>

        <!-- MODAL DE UPLOAD SIMPLIFICADO -->
        <div id="modalUploadBCRA" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; overflow-y: auto; padding: 20px;">
            <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 20px; padding: 30px 20px; max-width: 500px; width: 100%; margin: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); position: relative;">
                
                <!-- Bot√≥n X para cerrar -->
                <button onclick="cerrarModalSinCargar()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.1); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; z-index: 1;">
                    ‚úï
                </button>
                
                <h2 style="color: white; margin: 0 0 12px 0; font-size: 22px; padding-right: 40px;">üìÅ Archivo Compartido</h2>
                <p style="color: #94a3b8; margin: 0 0 20px 0; line-height: 1.5; font-size: 14px;">
                    Selecciona una opci√≥n:
                </p>

                <!-- Opci√≥n 1: Ver archivo del admin -->
                <div id="opcionAdmin" style="display: none; background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 12px; padding: 16px; margin-bottom: 16px; cursor: pointer;" onclick="verArchivoAdmin()">
                    <p style="color: #22c55e; margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">‚úÖ Ver archivo del administrador</p>
                    <p id="infoAdmin" style="color: #94a3b8; margin: 0; font-size: 13px;"></p>
                </div>

                <!-- Opci√≥n 2: Subir archivo (SOLO ADMIN) -->
                <div id="opcionSubir" style="display: none; background: rgba(59, 130, 246, 0.1); border: 2px dashed #3b82f6; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s;" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 40px; margin-bottom: 8px;">üìÅ</div>
                    <p style="color: #60a5fa; margin: 0 0 4px 0; font-weight: 600; font-size: 14px;">Subir archivo</p>
                    <p style="color: #94a3b8; margin: 0; font-size: 12px;">Cualquier tipo de archivo</p>
                    <input type="file" id="fileInput" style="display: none;" onchange="procesarArchivo(event)">
                </div>

                <div id="uploadStatus" style="display: none; padding: 12px; border-radius: 8px; margin-top: 16px; font-size: 13px;"></div>

                <button id="btnContinuar" onclick="cerrarModalUpload()" disabled style="width: 100%; margin-top: 16px; padding: 12px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: not-allowed; font-size: 14px; font-weight: 600; opacity: 0.5; transition: all 0.3s;">
                    Continuar
                </button>
            </div>
        </div>
    </div>

    <div id="bottomNav" class="bottom-nav">
        <button class="nav-item active" onclick="showSection('ipc-emae')">
            <div class="icon">üìä</div>
            <div class="label">IPC & EMAE</div>
        </button>
        <button class="nav-item" onclick="showSection('bcra')">
            <div class="icon">üè¶</div>
            <div class="label">BCRA</div>
        </button>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-flag">
            <div class="flag-stripe flag-celeste"></div>
            <div class="flag-stripe flag-blanca">
                <div class="flag-sol"></div>
            </div>
            <div class="flag-stripe flag-celeste"></div>
        </div>
        <div class="loading-text">Cargando datos BCRA...</div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN DE SUPABASE
        // ==========================================
        const SUPABASE_URL = 'https://ihlwrzdspuqbhwqfgzta.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlobHdyemRzcHVxYmh3cWZnenRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNDgwMDAsImV4cCI6MjA4NTcyNDAwMH0.0Dw7eS5N3EawIlU3NAN517qxWhUTb9u6ntRSAazudnU';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function guardarEnSupabase(fileData) {
            try {
                console.log('Guardando en Supabase Storage...');
                
                // Convertir base64 a blob
                const base64Response = await fetch(fileData.contenido);
                const blob = await base64Response.blob();
                
                console.log('Archivo convertido a blob:', blob.size, 'bytes');
                
                // Eliminar archivo anterior si existe
                const { data: listData, error: listError } = await supabaseClient.storage
                    .from('archivos')
                    .list();
                
                if (listData && listData.length > 0) {
                    console.log('Eliminando archivos anteriores...');
                    const filesToDelete = listData.map(f => f.name);
                    await supabaseClient.storage
                        .from('archivos')
                        .remove(filesToDelete);
                }
                
                // Subir nuevo archivo
                const fileName = `archivo_admin_${Date.now()}`;
                console.log('Subiendo archivo:', fileName);
                
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('archivos')
                    .upload(fileName, blob, {
                        contentType: fileData.tipo,
                        upsert: true
                    });
                
                if (uploadError) {
                    console.error('Error subiendo archivo:', uploadError);
                    throw new Error(`Error Storage: ${uploadError.message || JSON.stringify(uploadError)}`);
                }
                
                console.log('Archivo subido exitosamente, guardando metadata...');
                
                // Guardar metadata en la tabla
                const { error: deleteError } = await supabaseClient
                    .from('archivos')
                    .delete()
                    .eq('subido_por', 'admin');
                
                const { data, error } = await supabaseClient
                    .from('archivos')
                    .insert([{
                        nombre: fileData.nombre,
                        tipo: fileData.tipo,
                        tamano: fileData.tama√±o,
                        contenido: fileName,
                        subido_por: fileData.subidoPor
                    }])
                    .select();
                
                if (error) {
                    console.error('Error guardando metadata:', error);
                    throw new Error(`Error metadata: ${error.message || JSON.stringify(error)}`);
                }
                
                console.log('‚úÖ Guardado en Supabase Storage exitoso');
                return true;
            } catch (error) {
                console.error('Error completo:', error);
                const errorMsg = error.message || error.error_description || JSON.stringify(error);
                throw new Error(errorMsg);
            }
        }
        
        async function cargarDesdeSupabase() {
            try {
                console.log('Cargando desde Supabase...');
                
                // Obtener metadata
                const { data, error } = await supabaseClient
                    .from('archivos')
                    .select('*')
                    .eq('subido_por', 'admin')
                    .order('fecha', { ascending: false })
                    .limit(1);
                
                if (error) {
                    console.error('Error Supabase:', error);
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    console.log('No hay archivos en Supabase');
                    return null;
                }
                
                const archivo = data[0];
                
                // Obtener URL p√∫blica del archivo
                const { data: publicUrlData } = supabaseClient.storage
                    .from('archivos')
                    .getPublicUrl(archivo.contenido);
                
                // Descargar el archivo como base64
                const response = await fetch(publicUrlData.publicUrl);
                const blob = await response.blob();
                
                const reader = new FileReader();
                const base64Promise = new Promise((resolve) => {
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
                
                const contenidoBase64 = await base64Promise;
                
                const fileData = {
                    nombre: archivo.nombre,
                    tipo: archivo.tipo,
                    tama√±o: archivo.tamano,
                    contenido: contenidoBase64,
                    fecha: archivo.fecha,
                    subidoPor: archivo.subido_por
                };
                
                console.log('‚úÖ Archivo cargado desde Supabase');
                return fileData;
            } catch (error) {
                console.error('Error cargando desde Supabase:', error);
                return null;
            }
        }

        // ==========================================
        // DATOS DE PBI MENSUAL (HARDCODEADOS)
        // Actualizado hasta 2028 - Valores en millones $
        // Fuente: pib_MIOS.xlsx
        // ==========================================
        const PBI_DATA = {
            "2017-01": 8913531, "2017-02": 8732335, "2017-03": 10076766, "2017-04": 9871264, "2017-05": 10967992, "2017-06": 10835367, "2017-07": 10830959, "2017-08": 11221744, "2017-09": 11296562, "2017-10": 11540332, "2017-11": 11826140, "2017-12": 11809743,
            "2018-01": 11809390, "2018-02": 11858724, "2018-03": 13705255, "2018-04": 13737263, "2018-05": 14850792, "2018-06": 14706126, "2018-07": 14792978, "2018-08": 15525525, "2018-09": 15510322, "2018-10": 16837257, "2018-11": 16944575, "2018-12": 16659515,
            "2019-01": 16704727, "2019-02": 16792732, "2019-03": 18954866, "2019-04": 19916698, "2019-05": 22394494, "2019-06": 21389481, "2019-07": 21842009, "2019-08": 22278637, "2019-09": 22791005, "2019-10": 24832326, "2019-11": 25181339, "2019-12": 25623010,
            "2020-01": 25591421, "2020-02": 24701968, "2020-03": 24706574, "2020-04": 21361595, "2020-05": 24771546, "2020-06": 25942943, "2020-07": 26411415, "2020-08": 27308450, "2020-09": 28889272, "2020-10": 30970073, "2020-11": 32097759, "2020-12": 33764748,
            "2021-01": 34403422, "2021-02": 34236138, "2021-03": 41715768, "2021-04": 44261650, "2021-05": 47085164, "2021-06": 47674029, "2021-07": 46388476, "2021-08": 46934080, "2021-09": 49065030, "2021-10": 51016094, "2021-11": 54282319, "2021-12": 57566827,
            "2022-01": 55965139, "2022-02": 57265105, "2022-03": 67805731, "2022-04": 73455333, "2022-05": 80251543, "2022-06": 82324012, "2022-07": 82799518, "2022-08": 87991521, "2022-09": 92799051, "2022-10": 98681659, "2022-11": 105352899, "2022-12": 109029029,
            "2023-01": 111512257, "2023-02": 113183665, "2023-03": 137462747, "2023-04": 144994099, "2023-05": 161388477, "2023-06": 171264988, "2023-07": 181426312, "2023-08": 208010520, "2023-09": 230112366, "2023-10": 247699754, "2023-11": 275876993, "2023-12": 325966792,
            "2024-01": 381108500, "2024-02": 411481925, "2024-03": 477825677, "2024-04": 526204398, "2024-05": 579553563, "2024-06": 574057204, "2024-07": 620476597, "2024-08": 645876666, "2024-09": 662233021, "2024-10": 695227725, "2024-11": 709210273, "2024-12": 723659830,
            "2025-01": 717165900, "2025-02": 697368528, "2025-03": 757420246, "2025-04": 806886828, "2025-05": 852596668, "2025-06": 841854659, "2025-07": 879791530, "2025-08": 899622214, "2025-09": 935526549, "2025-10": 959036168, "2025-11": 940127015, "2025-12": 966290820,
            "2026-01": 958964729, "2026-02": 923872512, "2026-03": 1011092903, "2026-04": 1057267007, "2026-05": 1117652391, "2026-06": 1117327745, "2026-07": 1173828498, "2026-08": 1207199819, "2026-09": 1212776706, "2026-10": 1240479486, "2026-11": 1231588077, "2026-12": 1228165255,
            "2027-01": 1214009734, "2027-02": 1162217653, "2027-03": 1266851583, "2027-04": 1318143509, "2027-05": 1377641418, "2027-06": 1341819015, "2027-07": 1370855644, "2027-08": 1372878114, "2027-09": 1358483730, "2027-10": 1376064025, "2027-11": 1359158967, "2027-12": 1354025828,
            "2028-01": 1342138886, "2028-02": 1289176702, "2028-03": 1410786258, "2028-04": 1473283840, "2028-05": 1537466341, "2028-06": 1488071043, "2028-07": 1502975250, "2028-08": 1496684430, "2028-09": 1480469340, "2028-10": 1507251440, "2028-11": 1494670871, "2028-12": 1492819319
        };
        
        function obtenerPBI(fecha) {
            const year = fecha.getFullYear();
            const month = fecha.getMonth() + 1;
            const key = `${year}-${month.toString().padStart(2, '0')}`;
            return PBI_DATA[key] || null;
        }
        
        // Funci√≥n para parsear fechas del Excel SIN problemas de zona horaria
        function parseFechaExcel(fechaStr) {
            // Si ya es un Date, devolverlo
            if (fechaStr instanceof Date) {
                // Crear fecha UTC a mediod√≠a para evitar problemas de zona horaria
                return new Date(Date.UTC(
                    fechaStr.getFullYear(),
                    fechaStr.getMonth(),
                    fechaStr.getDate(),
                    12, 0, 0
                ));
            }
            
            // Si es string, parsearlo
            let fecha;
            
            // Intentar parsear diferentes formatos
            if (typeof fechaStr === 'string') {
                // Formato: "2026-02-04" o "2026/02/04"
                if (fechaStr.match(/^\d{4}[-/]\d{1,2}[-/]\d{1,2}/)) {
                    const parts = fechaStr.split(/[-/]/);
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // Mes es 0-indexed
                    const day = parseInt(parts[2]);
                    return new Date(Date.UTC(year, month, day, 12, 0, 0));
                }
                
                // Formato: "2/4/2026" o "02/04/2026" (mes/d√≠a/a√±o)
                if (fechaStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
                    const parts = fechaStr.split('/');
                    const month = parseInt(parts[0]) - 1; // Mes es 0-indexed
                    const day = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    return new Date(Date.UTC(year, month, day, 12, 0, 0));
                }
                
                // Fallback: crear fecha y ajustar a UTC mediod√≠a
                fecha = new Date(fechaStr);
            } else {
                // Si es n√∫mero u otro tipo, usar constructor normal
                fecha = new Date(fechaStr);
            }
            
            // Ajustar a UTC mediod√≠a para evitar problemas de zona horaria
            return new Date(Date.UTC(
                fecha.getFullYear(),
                fecha.getMonth(),
                fecha.getDate(),
                12, 0, 0
            ));
        }
        
        // Funci√≥n para convertir Date a string YYYY-MM-DD (sin problemas de zona horaria)
        function fechaToString(fecha) {
            const year = fecha.getUTCFullYear();
            const month = String(fecha.getUTCMonth() + 1).padStart(2, '0');
            const day = String(fecha.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Funci√≥n para crear Date local desde string YYYY-MM-DD (para comparaciones y display)
        function stringToFechaLocal(fechaStr) {
            const [year, month, day] = fechaStr.split('-').map(n => parseInt(n));
            return new Date(year, month - 1, day, 12, 0, 0);
        }
        
        async function procesarExcelBCRA(file) {
            try {
                console.log('Procesando Excel BCRA (Base Monetaria + Dep√≥sitos)...');
                
                if (typeof XLSX === 'undefined') {
                    throw new Error('La librer√≠a XLSX no se carg√≥ correctamente. Recarga la p√°gina.');
                }
                
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                console.log('Hojas disponibles:', workbook.SheetNames);
                
                // ============================================
                // PROCESAR BASE MONETARIA
                // ============================================
                console.log('\n=== PROCESANDO BASE MONETARIA ===');
                const sheetBM = workbook.SheetNames.find(name => 
                    name.toUpperCase().includes('BASE') && name.toUpperCase().includes('MONET')
                );
                
                if (!sheetBM) {
                    throw new Error('No se encontr√≥ la hoja BASE MONETARIA');
                }
                
                console.log('Hoja BASE MONETARIA:', sheetBM);
                const worksheetBM = workbook.Sheets[sheetBM];
                const dataBM = XLSX.utils.sheet_to_json(worksheetBM, { header: 1, raw: false, defval: null });
                
                let startRowBM = -1;
                for (let i = 0; i < Math.min(dataBM.length, 50); i++) {
                    const primeraColumna = dataBM[i][0];
                    if (primeraColumna && typeof primeraColumna === 'string' && 
                        (primeraColumna.startsWith('20') || primeraColumna.includes('2003'))) {
                        startRowBM = i;
                        break;
                    }
                    if (primeraColumna) {
                        const fecha = new Date(primeraColumna);
                        if (!isNaN(fecha.getTime()) && fecha.getFullYear() >= 2000 && fecha.getFullYear() <= 2030) {
                            startRowBM = i;
                            break;
                        }
                    }
                }
                
                if (startRowBM === -1) {
                    throw new Error('No se encontr√≥ inicio de datos en BASE MONETARIA');
                }
                
                const datosBaseMon = [];
                for (let i = startRowBM; i < dataBM.length; i++) {
                    const fechaStr = dataBM[i][0];
                    const valorAF = dataBM[i][31]; // Columna AF
                    
                    if (!fechaStr || !valorAF) continue;
                    
                    const fecha = parseFechaExcel(fechaStr);
                    if (isNaN(fecha.getTime()) || fecha.getFullYear() < 2017) continue;
                    
                    const pbi = obtenerPBI(fecha);
                    if (!pbi) continue;
                    
                    const valor = parseFloat(String(valorAF).replace(/,/g, ''));
                    if (isNaN(valor)) continue;
                    
                    datosBaseMon.push({
                        fecha: fechaToString(fecha),
                        valor: valor,
                        porcentaje_pbi: parseFloat(((valor / pbi) * 100).toFixed(4))
                    });
                }
                
                console.log(`‚úÖ Base Monetaria: ${datosBaseMon.length} registros`);
                
                // ============================================
                // PROCESAR DEP√ìSITOS TOTALES
                // ============================================
                console.log('\n=== PROCESANDO DEP√ìSITOS TOTALES ===');
                let datosDepositos = []; // Declarar aqu√≠ para que est√© disponible en todo el scope
                
                const sheetDEP = workbook.SheetNames.find(name => 
                    name.toUpperCase().includes('DEP')
                );
                
                if (!sheetDEP) {
                    console.warn('No se encontr√≥ hoja DEP√ìSITOS');
                } else {
                    console.log('Hoja DEP√ìSITOS:', sheetDEP);
                    const worksheetDEP = workbook.Sheets[sheetDEP];
                    const dataDEP = XLSX.utils.sheet_to_json(worksheetDEP, { header: 1, raw: false, defval: null });
                    
                    let startRowDEP = -1;
                    for (let i = 0; i < Math.min(dataDEP.length, 50); i++) {
                        const primeraColumna = dataDEP[i][0];
                        if (primeraColumna && typeof primeraColumna === 'string' && 
                            (primeraColumna.startsWith('20') || primeraColumna.includes('2002'))) {
                            startRowDEP = i;
                            break;
                        }
                        if (primeraColumna) {
                            const fecha = new Date(primeraColumna);
                            if (!isNaN(fecha.getTime()) && fecha.getFullYear() >= 2000 && fecha.getFullYear() <= 2030) {
                                startRowDEP = i;
                                break;
                            }
                        }
                    }
                    
                    if (startRowDEP === -1) {
                        console.warn('No se encontr√≥ inicio de datos en DEP√ìSITOS');
                    } else {
                        console.log('Primera fila de datos en DEP√ìSITOS:', startRowDEP);
                        
                        datosDepositos = []; // Ya declarado arriba, solo reiniciar
                        for (let i = startRowDEP; i < dataDEP.length; i++) {
                            const fechaStr = dataDEP[i][0];
                            const valorX = dataDEP[i][23]; // Columna X (idx 23) - Dep√≥sitos Totales Sector Privado
                            
                            if (!fechaStr || !valorX) continue;
                            
                            const fecha = parseFechaExcel(fechaStr);
                            if (isNaN(fecha.getTime()) || fecha.getFullYear() < 2017) continue;
                            
                            const pbi = obtenerPBI(fecha);
                            if (!pbi) continue;
                            
                            const valor = parseFloat(String(valorX).replace(/,/g, ''));
                            if (isNaN(valor)) continue;
                            
                            datosDepositos.push({
                                fecha: fechaToString(fecha),
                                valor_millones: valor,
                                porcentaje_pbi: parseFloat(((valor / pbi) * 100).toFixed(4))
                            });
                        }
                        
                        console.log(`‚úÖ Dep√≥sitos Totales: ${datosDepositos.length} registros`);
                        console.log('Primeros 3:', datosDepositos.slice(0, 3));
                        console.log('√öltimos 3:', datosDepositos.slice(-3));
                        
                        if (datosDepositos.length > 0) {
                            await guardarDatosSupabase('depositos_totales', datosDepositos);
                        }
                        
                        // ============================================
                        // PROCESAR M2 TRANSACCIONAL (misma hoja)
                        // ============================================
                        console.log('\n=== PROCESANDO M2 TRANSACCIONAL ===');
                        const datosM2 = [];
                        for (let i = startRowDEP; i < dataDEP.length; i++) {
                            const fechaStr = dataDEP[i][0];
                            const valorAD = dataDEP[i][29]; // Columna AD (M2 Transaccional)
                            
                            if (!fechaStr || !valorAD) continue;
                            
                            const fecha = parseFechaExcel(fechaStr);
                            if (isNaN(fecha.getTime()) || fecha.getFullYear() < 2017) continue;
                            
                            const pbi = obtenerPBI(fecha);
                            if (!pbi) continue;
                            
                            const valor = parseFloat(String(valorAD).replace(/,/g, ''));
                            if (isNaN(valor)) continue;
                            
                            datosM2.push({
                                fecha: fechaToString(fecha),
                                valor_millones: valor,  // ‚ö†Ô∏è valor_millones, NO valor
                                porcentaje_pbi: parseFloat(((valor / pbi) * 100).toFixed(4))
                            });
                        }
                        
                        console.log(`‚úÖ M2 Transaccional: ${datosM2.length} registros`);
                        console.log('Primeros 3:', datosM2.slice(0, 3));
                        console.log('√öltimos 3:', datosM2.slice(-3));
                        
                        if (datosM2.length > 0) {
                            await guardarDatosSupabase('m2_transaccional', datosM2);
                        }
                    }
                }
                
                // ============================================
                // PROCESAR PR√âSTAMOS EN PESOS
                // ============================================
                console.log('\n=== PROCESANDO PR√âSTAMOS EN PESOS ===');
                let datosPrestPesos = [];
                let datosPrestDolares = [];
                let datosPrestTotales = [];
                
                const sheetPREST = workbook.SheetNames.find(name => 
                    name.toUpperCase().includes('PREST') || name.toUpperCase().includes('PR√âST')
                );
                
                if (!sheetPREST) {
                    console.warn('No se encontr√≥ hoja PR√âSTAMOS');
                } else {
                    console.log('Hoja PR√âSTAMOS:', sheetPREST);
                    const worksheetPREST = workbook.Sheets[sheetPREST];
                    const dataPREST = XLSX.utils.sheet_to_json(worksheetPREST, { header: 1, raw: false, defval: null });
                    
                    let startRowPREST = -1;
                    for (let i = 0; i < Math.min(dataPREST.length, 50); i++) {
                        const primeraColumna = dataPREST[i][0];
                        if (primeraColumna && typeof primeraColumna === 'string' && 
                            (primeraColumna.startsWith('20') || primeraColumna.includes('2002'))) {
                            startRowPREST = i;
                            break;
                        }
                        if (primeraColumna) {
                            const fecha = new Date(primeraColumna);
                            if (!isNaN(fecha.getTime()) && fecha.getFullYear() >= 2000 && fecha.getFullYear() <= 2030) {
                                startRowPREST = i;
                                break;
                            }
                        }
                    }
                    
                    if (startRowPREST === -1) {
                        console.warn('No se encontr√≥ inicio de datos en PR√âSTAMOS');
                    } else {
                        console.log('Primera fila de datos en PR√âSTAMOS:', startRowPREST);
                        
                        datosPrestPesos = [];
                        for (let i = startRowPREST; i < dataPREST.length; i++) {
                            const fechaStr = dataPREST[i][0];
                            const valorI = dataPREST[i][8]; // Columna I (idx 8) - Pr√©stamos en Pesos
                            
                            if (!fechaStr || !valorI) continue;
                            
                            const fecha = parseFechaExcel(fechaStr);
                            if (isNaN(fecha.getTime()) || fecha.getFullYear() < 2017) continue;
                            
                            const pbi = obtenerPBI(fecha);
                            if (!pbi) continue;
                            
                            const valor = parseFloat(String(valorI).replace(/,/g, ''));
                            if (isNaN(valor)) continue;
                            
                            datosPrestPesos.push({
                                fecha: fechaToString(fecha),
                                valor_millones: valor,
                                porcentaje_pbi: parseFloat(((valor / pbi) * 100).toFixed(4))
                            });
                        }
                        
                        console.log(`‚úÖ Pr√©stamos en Pesos: ${datosPrestPesos.length} registros`);
                        console.log('Primeros 3:', datosPrestPesos.slice(0, 3));
                        console.log('√öltimos 3:', datosPrestPesos.slice(-3));
                        
                        if (datosPrestPesos.length > 0) {
                            await guardarDatosSupabase('prestamos_pesos', datosPrestPesos);
                        }
                        
                        // ============================================
                        // PROCESAR PR√âSTAMOS EN D√ìLARES (misma hoja)
                        // ============================================
                        console.log('\n=== PROCESANDO PR√âSTAMOS EN D√ìLARES ===');
                        datosPrestDolares = [];
                        for (let i = startRowPREST; i < dataPREST.length; i++) {
                            const fechaStr = dataPREST[i][0];
                            const valorS = dataPREST[i][18]; // Columna S (idx 18) - Pr√©stamos en D√≥lares
                            
                            if (!fechaStr || !valorS) continue;
                            
                            const fecha = parseFechaExcel(fechaStr);
                            if (isNaN(fecha.getTime()) || fecha.getFullYear() < 2017) continue;
                            
                            const pbi = obtenerPBI(fecha);
                            if (!pbi) continue;
                            
                            const valor = parseFloat(String(valorS).replace(/,/g, ''));
                            if (isNaN(valor)) continue;
                            
                            datosPrestDolares.push({
                                fecha: fechaToString(fecha),
                                valor_millones: valor,
                                porcentaje_pbi: parseFloat(((valor / pbi) * 100).toFixed(4))
                            });
                        }
                        
                        console.log(`‚úÖ Pr√©stamos en D√≥lares: ${datosPrestDolares.length} registros`);
                        console.log('Primeros 3:', datosPrestDolares.slice(0, 3));
                        console.log('√öltimos 3:', datosPrestDolares.slice(-3));
                        
                        if (datosPrestDolares.length > 0) {
                            await guardarDatosSupabase('prestamos_dolares', datosPrestDolares);
                        }
                        
                        // ============================================
                        // PROCESAR PR√âSTAMOS TOTALES (misma hoja)
                        // ============================================
                        console.log('\n=== PROCESANDO PR√âSTAMOS TOTALES ===');
                        datosPrestTotales = [];
                        for (let i = startRowPREST; i < dataPREST.length; i++) {
                            const fechaStr = dataPREST[i][0];
                            const valorU = dataPREST[i][20]; // Columna U (idx 20) - Pr√©stamos Totales
                            
                            if (!fechaStr || !valorU) continue;
                            
                            const fecha = parseFechaExcel(fechaStr);
                            if (isNaN(fecha.getTime()) || fecha.getFullYear() < 2017) continue;
                            
                            const pbi = obtenerPBI(fecha);
                            if (!pbi) continue;
                            
                            const valor = parseFloat(String(valorU).replace(/,/g, ''));
                            if (isNaN(valor)) continue;
                            
                            datosPrestTotales.push({
                                fecha: fechaToString(fecha),
                                valor_millones: valor,
                                porcentaje_pbi: parseFloat(((valor / pbi) * 100).toFixed(4))
                            });
                        }
                        
                        console.log(`‚úÖ Pr√©stamos Totales: ${datosPrestTotales.length} registros`);
                        console.log('Primeros 3:', datosPrestTotales.slice(0, 3));
                        console.log('√öltimos 3:', datosPrestTotales.slice(-3));
                        
                        if (datosPrestTotales.length > 0) {
                            await guardarDatosSupabase('prestamos_totales', datosPrestTotales);
                        }
                    }
                }
                
                // Guardar Base Monetaria
                if (datosBaseMon.length > 0) {
                    await guardarDatosSupabase('base_monetaria', datosBaseMon);
                }
                
                console.log('\n‚úÖ EXCEL PROCESADO EXITOSAMENTE');
                return { 
                    base_monetaria: datosBaseMon.length, 
                    m2_transaccional: datosM2.length,
                    depositos: datosDepositos.length,
                    prestamos_pesos: datosPrestPesos.length,
                    prestamos_dolares: datosPrestDolares.length,
                    prestamos_totales: datosPrestTotales.length
                };
                
            } catch (error) {
                console.error('Error procesando Excel BCRA:', error);
                throw error;
            }
        }
        
        async function guardarDatosSupabase(tabla, datos) {
            console.log(`\nGuardando ${datos.length} registros en ${tabla}...`);
            
            // Eliminar datos anteriores
            const { error: deleteError } = await supabaseClient
                .from(tabla)
                .delete()
                .gte('id', 0);
            
            if (deleteError) {
                console.error(`Error eliminando ${tabla}:`, deleteError);
                throw deleteError;
            }
            
            // Insertar en lotes de 1000
            const batchSize = 1000;
            for (let i = 0; i < datos.length; i += batchSize) {
                const batch = datos.slice(i, i + batchSize);
                const { error } = await supabaseClient
                    .from(tabla)
                    .insert(batch);
                
                if (error) {
                    console.error(`Error insertando batch en ${tabla}:`, error);
                    throw error;
                }
                
                console.log(`  Batch ${Math.floor(i/batchSize) + 1} guardado`);
            }
            
            console.log(`‚úÖ ${tabla} guardado exitosamente`);
        }
        
        async function guardarBaseMonerariaSupabase(datos) {
            try {
                console.log('Guardando datos en Supabase...');
                
                // Eliminar datos anteriores
                const { error: deleteError } = await supabaseClient
                    .from('base_monetaria')
                    .delete()
                    .gte('id', 0);
                
                // Insertar nuevos datos en lotes de 1000
                const batchSize = 1000;
                for (let i = 0; i < datos.length; i += batchSize) {
                    const batch = datos.slice(i, i + batchSize);
                    const { error } = await supabaseClient
                        .from('base_monetaria')
                        .insert(batch);
                    
                    if (error) {
                        console.error('Error insertando batch:', error);
                        throw error;
                    }
                    
                    console.log(`Batch ${Math.floor(i/batchSize) + 1} insertado (${batch.length} registros)`);
                }
                
                console.log('‚úÖ Datos guardados en Supabase');
                return true;
                
            } catch (error) {
                console.error('Error guardando en Supabase:', error);
                throw error;
            }
        }
        
        // ==========================================
        // DASHBOARD BCRA - BASE MONETARIA
        // ==========================================
        let chartBM = null;
        let datosBM = [];
        let cargandoBCRA = false;
        let fechaDesdeBCRA = null;
        let fechaHastaBCRA = null;
        
        // DEP√ìSITOS TOTALES
        let chartDEP = null;
        let datosDEP = [];
        let fechaDesdeDEP = null;
        let fechaHastaDEP = null;
        
        // M2 TRANSACCIONAL
        let chartM2 = null;
        let datosM2 = [];
        let fechaDesdeM2 = null;
        let fechaHastaM2 = null;
        
        // PR√âSTAMOS EN PESOS
        let chartPrestPesos = null;
        let datosPrestPesos = [];
        let fechaDesdePrestPesos = null;
        let fechaHastaPrestPesos = null;
        
        // PR√âSTAMOS EN D√ìLARES
        let chartPrestDolares = null;
        let datosPrestDolares = [];
        let fechaDesdePrestDolares = null;
        let fechaHastaPrestDolares = null;
        
        // PR√âSTAMOS TOTALES
        let chartPrestTotales = null;
        let datosPrestTotales = [];
        let fechaDesdePrestTotales = null;
        let fechaHastaPrestTotales = null;
        
        async function mostrarDashboardBCRA() {
            if (cargandoBCRA) {
                console.log('Ya se est√° cargando el dashboard, esperando...');
                return;
            }
            
            // Mostrar loading con bandera
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';
            
            cargandoBCRA = true;
            
            try {
                console.log('Cargando dashboard BCRA...');
                
                // Cargar TODOS los datos de Supabase con paginaci√≥n
                console.log('Cargando datos con paginaci√≥n...');
                datosBM = [];
                let offset = 0;
                const pageSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const { data, error } = await supabaseClient
                        .from('base_monetaria')
                        .select('*')
                        .order('fecha', { ascending: true })
                        .range(offset, offset + pageSize - 1);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        datosBM = datosBM.concat(data);
                        console.log(`P√°gina cargada: ${data.length} registros (total: ${datosBM.length})`);
                        offset += pageSize;
                        hasMore = data.length === pageSize;
                    } else {
                        hasMore = false;
                    }
                }
                
                if (datosBM.length === 0) {
                    console.log('No hay datos disponibles');
                    cargandoBCRA = false;
                    return;
                }
                
                console.log(`‚úÖ Total datos cargados: ${datosBM.length} registros`);
                
                // Cargar Dep√≥sitos Totales
                try {
                    await cargarDatosDEP();
                    console.log(`‚úÖ Dep√≥sitos Totales cargados: ${datosDEP.length} registros`);
                } catch (error) {
                    console.error('Error cargando Dep√≥sitos:', error);
                }
                
                // Cargar M2 Transaccional
                try {
                    await cargarDatosM2();
                    console.log(`‚úÖ M2 Transaccional cargados: ${datosM2.length} registros`);
                } catch (error) {
                    console.error('Error cargando M2:', error);
                }
                
                // Cargar Pr√©stamos en Pesos
                try {
                    await cargarDatosPrestPesos();
                    console.log(`‚úÖ Pr√©stamos en Pesos cargados: ${datosPrestPesos.length} registros`);
                } catch (error) {
                    console.error('Error cargando Pr√©stamos en Pesos:', error);
                }
                
                // Cargar Pr√©stamos en D√≥lares
                try {
                    await cargarDatosPrestDolares();
                    console.log(`‚úÖ Pr√©stamos en D√≥lares cargados: ${datosPrestDolares.length} registros`);
                } catch (error) {
                    console.error('Error cargando Pr√©stamos en D√≥lares:', error);
                }
                
                // Cargar Pr√©stamos Totales
                try {
                    await cargarDatosPrestTotales();
                    console.log(`‚úÖ Pr√©stamos Totales cargados: ${datosPrestTotales.length} registros`);
                } catch (error) {
                    console.error('Error cargando Pr√©stamos Totales:', error);
                }
                
                // Actualizar info de √∫ltima actualizaci√≥n
                const ultimoDato = datosBM[datosBM.length - 1];
                document.getElementById('lastUpdateBCRA').textContent = 
                    `√öltima actualizaci√≥n: ${new Date(ultimoDato.updated_at).toLocaleString('es-AR')}`;
                
                // PRIMERO: Inicializar selectores de fechas del gr√°fico (configura fechaDesdeBCRA y fechaHastaBCRA)
                inicializarSelectoresFechasBCRA();
                
                // SEGUNDO: Inicializar gr√°fico (usa las fechas configuradas arriba)
                if (!chartsInitialized) {
                    initCharts();
                    chartsInitialized = true;
                }
                inicializarChartBCRA();
                
                // Mostrar secci√≥n BCRA resumen
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('bcraSection').classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                const navItems = document.querySelectorAll('.nav-item');
                navItems[1].classList.add('active'); // BCRA es ahora el √≠ndice 1
                
                // Calcular fechas para el resumen (usar stringToFechaLocal para evitar zona horaria)
                const primeraFecha = stringToFechaLocal(datosBM[0].fecha);
                const ultimaFecha = stringToFechaLocal(datosBM[datosBM.length - 1].fecha);
                
                // Default: diciembre 2023 hasta √∫ltima fecha
                const fechaDesdeDefault = stringToFechaLocal('2023-12-01');
                
                // Inicializar selectores de fechas del resumen
                const inputDesdeResumen = document.getElementById('fechaDesdeBCRAResumen');
                const inputHastaResumen = document.getElementById('fechaHastaBCRAResumen');
                
                inputDesdeResumen.value = fechaDesdeDefault.toISOString().split('T')[0];
                inputHastaResumen.value = ultimaFecha.toISOString().split('T')[0];
                inputDesdeResumen.min = primeraFecha.toISOString().split('T')[0];
                inputDesdeResumen.max = ultimaFecha.toISOString().split('T')[0];
                inputHastaResumen.min = primeraFecha.toISOString().split('T')[0];
                inputHastaResumen.max = ultimaFecha.toISOString().split('T')[0];
                
                // Calcular estad√≠sticas iniciales
                aplicarFiltroResumenBCRA();
                
                // Aplicar filtro de Dep√≥sitos si hay datos
                if (datosDEP.length > 0) {
                    aplicarFiltroResumenDEP();
                }
                
                // Aplicar filtro de M2 si hay datos
                if (datosM2.length > 0) {
                    aplicarFiltroResumenM2();
                }
                
                // Aplicar filtro de Pr√©stamos en Pesos si hay datos
                if (datosPrestPesos.length > 0) {
                    aplicarFiltroResumenPrestPesos();
                }
                
                // Aplicar filtro de Pr√©stamos en D√≥lares si hay datos
                if (datosPrestDolares.length > 0) {
                    aplicarFiltroResumenPrestDolares();
                }
                
                // Aplicar filtro de Pr√©stamos Totales si hay datos
                if (datosPrestTotales.length > 0) {
                    aplicarFiltroResumenPrestTotales();
                }
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                alert('Error al cargar los datos: ' + error.message);
            } finally {
                cargandoBCRA = false;
                // Ocultar loading
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'none';
            }
        }
        
        function inicializarSelectoresFechasBCRA() {
            // Obtener primera y √∫ltima fecha de los datos (ya son strings "YYYY-MM-DD")
            const primeraFechaStr = datosBM[0].fecha;
            const ultimaFechaStr = datosBM[datosBM.length - 1].fecha;
            
            // Default: diciembre 2023 hasta √∫ltima fecha
            const fechaDesdeDefaultStr = '2023-12-01';
            
            // Configurar inputs
            const inputDesde = document.getElementById('fechaDesdeBCRA');
            const inputHasta = document.getElementById('fechaHastaBCRA');
            
            inputDesde.value = fechaDesdeDefaultStr;
            inputHasta.value = ultimaFechaStr;
            
            // Establecer l√≠mites de los inputs
            inputDesde.min = primeraFechaStr;
            inputDesde.max = ultimaFechaStr;
            inputHasta.min = primeraFechaStr;
            inputHasta.max = ultimaFechaStr;
            
            // Guardar como objetos Date para filtros
            fechaDesdeBCRA = stringToFechaLocal(fechaDesdeDefaultStr);
            fechaHastaBCRA = stringToFechaLocal(ultimaFechaStr);
        }
        
        function aplicarFiltroBCRA() {
            const inputDesde = document.getElementById('fechaDesdeBCRA');
            const inputHasta = document.getElementById('fechaHastaBCRA');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            fechaDesdeBCRA = new Date(inputDesde.value + 'T00:00:00');
            fechaHastaBCRA = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesdeBCRA > fechaHastaBCRA) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            actualizarChartBCRA();
        }
        
        function aplicarFiltroResumenBCRA() {
            const inputDesde = document.getElementById('fechaDesdeBCRAResumen');
            const inputHasta = document.getElementById('fechaHastaBCRAResumen');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            const fechaDesde = new Date(inputDesde.value + 'T00:00:00');
            const fechaHasta = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesde > fechaHasta) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            // Filtrar datos
            const datosFiltrados = datosBM.filter(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha >= fechaDesde && fecha <= fechaHasta;
            });
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            // Calcular estad√≠sticas
            const valores = datosFiltrados.map(d => d.porcentaje_pbi);
            
            const primero = datosFiltrados[0];
            const ultimo = datosFiltrados[datosFiltrados.length - 1];
            const promedio = (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2);
            
            let maximo = datosFiltrados[0];
            let minimo = datosFiltrados[0];
            datosFiltrados.forEach(d => {
                if (d.porcentaje_pbi > maximo.porcentaje_pbi) maximo = d;
                if (d.porcentaje_pbi < minimo.porcentaje_pbi) minimo = d;
            });
            
            // Funci√≥n auxiliar para formatear fecha
            const formatearFecha = (fecha) => {
                const f = stringToFechaLocal(fecha);
                return f.toLocaleDateString('es-AR', { day: 'numeric', month: 'short', year: 'numeric' }).replace('.', '');
            };
            
            // Actualizar tarjetas
            document.getElementById('bm-primero').textContent = primero.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('bm-primero-fecha').textContent = formatearFecha(primero.fecha);
            
            document.getElementById('bm-ultimo').textContent = ultimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('bm-ultimo-fecha').textContent = formatearFecha(ultimo.fecha);
            
            document.getElementById('bm-promedio').textContent = promedio + '%';
            
            document.getElementById('bm-maximo').textContent = maximo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('bm-maximo-fecha').textContent = formatearFecha(maximo.fecha);
            
            document.getElementById('bm-minimo').textContent = minimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('bm-minimo-fecha').textContent = formatearFecha(minimo.fecha);
        }
        
        function inicializarChartBCRA() {
            const ctx = document.getElementById('chartBM');
            if (!ctx) return;
            
            const datosFiltrados = filtrarDatosBCRAPorFechas();
            
            if (chartBM) {
                chartBM.destroy();
            }
            
            // Detectar si es m√≥vil
            const isMobile = window.innerWidth <= 768;
            
            chartBM = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: datosFiltrados.map(d => {
                        const fecha = stringToFechaLocal(d.fecha);
                        return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
                    }),
                    datasets: [{
                        label: 'Base Monetaria (% PBI)',
                        data: datosFiltrados.map(d => d.porcentaje_pbi),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: isMobile ? 2 : 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 16,
                            titleFont: { size: 14, weight: '600' },
                            bodyFont: { size: 16, weight: '700' },
                            titleColor: '#94a3b8',
                            bodyColor: '#fff',
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const fecha = stringToFechaLocal(datosFiltrados[context[0].dataIndex].fecha);
                                    return fecha.toLocaleDateString('es-AR', { day: '2-digit', month: 'long', year: 'numeric' });
                                },
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + '% del PBI';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 10 : 13 },
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 9 : 12 },
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: isMobile ? 6 : 20
                            }
                        }
                    }
                }
            });
            
            // Agregar eventos touch para m√≥vil (ocultar tooltip al dejar de tocar)
            if (isMobile) {
                const canvas = ctx;
                let touchTimeout;
                let isTouch = false;
                
                canvas.addEventListener('touchstart', function(e) {
                    clearTimeout(touchTimeout);
                    isTouch = true;
                });
                
                canvas.addEventListener('touchmove', function(e) {
                    isTouch = true;
                });
                
                canvas.addEventListener('touchend', function(e) {
                    if (!isTouch) return;
                    
                    // Ocultar TODO inmediatamente al dejar de tocar
                    touchTimeout = setTimeout(() => {
                        if (chartBM && chartBM.data && chartBM.data.datasets[0]) {
                            // Forzar ocultaci√≥n de puntos
                            chartBM.data.datasets[0].pointRadius = 0;
                            chartBM.data.datasets[0].pointHoverRadius = 0;
                            
                            // Limpiar elementos activos
                            chartBM.tooltip.setActiveElements([]);
                            chartBM.setActiveElements([]);
                            chartBM.update('none');
                            
                            // Restaurar configuraci√≥n despu√©s de 100ms
                            setTimeout(() => {
                                if (chartBM && chartBM.data && chartBM.data.datasets[0]) {
                                    chartBM.data.datasets[0].pointRadius = 0;
                                    chartBM.data.datasets[0].pointHoverRadius = 8;
                                }
                            }, 100);
                        }
                        isTouch = false;
                    }, 200);
                });
                
                canvas.addEventListener('touchcancel', function(e) {
                    clearTimeout(touchTimeout);
                    if (chartBM && chartBM.data && chartBM.data.datasets[0]) {
                        chartBM.data.datasets[0].pointRadius = 0;
                        chartBM.data.datasets[0].pointHoverRadius = 0;
                        chartBM.tooltip.setActiveElements([]);
                        chartBM.setActiveElements([]);
                        chartBM.update('none');
                        setTimeout(() => {
                            if (chartBM && chartBM.data && chartBM.data.datasets[0]) {
                                chartBM.data.datasets[0].pointRadius = 0;
                                chartBM.data.datasets[0].pointHoverRadius = 8;
                            }
                        }, 100);
                    }
                    isTouch = false;
                });
            }
        }
        
        function filtrarDatosBCRAPorFechas() {
            if (!fechaDesdeBCRA || !fechaHastaBCRA) {
                return datosBM;
            }
            
            // Encontrar el √≠ndice del primer dato >= fechaDesde
            let indiceDesde = datosBM.findIndex(d => stringToFechaLocal(d.fecha) >= fechaDesdeBCRA);
            
            // Si no hay dato exacto, buscar el m√°s cercano anterior
            if (indiceDesde === -1) {
                // Todas las fechas son menores, usar la √∫ltima
                indiceDesde = datosBM.length - 1;
            } else if (indiceDesde > 0 && stringToFechaLocal(datosBM[indiceDesde].fecha) > fechaDesdeBCRA) {
                // Si el dato encontrado es posterior a la fecha buscada, incluir el anterior
                indiceDesde = indiceDesde - 1;
            }
            
            // Encontrar el √≠ndice del √∫ltimo dato <= fechaHasta
            let indiceHasta = -1;
            for (let i = datosBM.length - 1; i >= 0; i--) {
                if (stringToFechaLocal(datosBM[i].fecha) <= fechaHastaBCRA) {
                    indiceHasta = i;
                    break;
                }
            }
            
            // Si no hay dato exacto, buscar el m√°s cercano anterior
            if (indiceHasta === -1) {
                // Todas las fechas son posteriores, no hay datos para mostrar
                return [];
            }
            
            return datosBM.slice(indiceDesde, indiceHasta + 1);
        }
        
        function actualizarChartBCRA() {
            if (!chartBM) return;
            
            const datosFiltrados = filtrarDatosBCRAPorFechas();
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            chartBM.data.labels = datosFiltrados.map(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
            });
            chartBM.data.datasets[0].data = datosFiltrados.map(d => d.porcentaje_pbi);
            chartBM.update();
        }
        
        async function cargarDatosBCRA() {
            try {
                // Verificar si hay datos en Supabase
                const { data, error } = await supabaseClient
                    .from('base_monetaria')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    console.error('Error verificando datos:', error.message);
                    mostrarModalUpload();
                    return;
                }
                
                if (data && data.length > 0) {
                    // Hay datos, mostrar dashboard
                    await mostrarDashboardBCRA();
                } else {
                    // No hay datos, mostrar modal de upload
                    console.log('No hay datos en Supabase, mostrando modal de upload');
                    mostrarModalUpload();
                }
            } catch (error) {
                console.error('Error verificando datos:', error.message || error);
                // En caso de error, mostrar modal
                mostrarModalUpload();
            }
        }

        // ==========================================
        // DEP√ìSITOS TOTALES - FUNCIONES
        // ==========================================
        
        async function cargarDatosDEP() {
            try {
                console.log('Cargando Dep√≥sitos Totales desde Supabase...');
                
                datosDEP = [];
                let offset = 0;
                const pageSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const { data, error } = await supabaseClient
                        .from('depositos_totales')
                        .select('*')
                        .order('fecha', { ascending: true })
                        .range(offset, offset + pageSize - 1);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        datosDEP = datosDEP.concat(data);
                        console.log(`DEP - P√°gina cargada: ${data.length} registros (total: ${datosDEP.length})`);
                        offset += pageSize;
                        hasMore = data.length === pageSize;
                    } else {
                        hasMore = false;
                    }
                }
                
                console.log(`‚úÖ Dep√≥sitos Totales cargados: ${datosDEP.length} registros`);
                return datosDEP;
                
            } catch (error) {
                console.error('Error cargando Dep√≥sitos Totales:', error);
                throw error;
            }
        }
        
        // ==========================================
        // M2 TRANSACCIONAL - FUNCIONES
        // ==========================================
        
        async function cargarDatosM2() {
            try {
                console.log('Cargando M2 Transaccional desde Supabase...');
                
                datosM2 = [];
                let offset = 0;
                const pageSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const { data, error } = await supabaseClient
                        .from('m2_transaccional')
                        .select('*')
                        .order('fecha', { ascending: true })
                        .range(offset, offset + pageSize - 1);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        datosM2 = datosM2.concat(data);
                        console.log(`M2 - P√°gina cargada: ${data.length} registros (total: ${datosM2.length})`);
                        offset += pageSize;
                        hasMore = data.length === pageSize;
                    } else {
                        hasMore = false;
                    }
                }
                
                console.log(`‚úÖ M2 Transaccional cargados: ${datosM2.length} registros`);
                console.log('Primeros 3:', datosM2.slice(0, 3));
                console.log('√öltimos 3:', datosM2.slice(-3));
                return datosM2;
                
            } catch (error) {
                console.error('Error cargando M2 Transaccional:', error);
                throw error;
            }
        }
        
        function aplicarFiltroResumenM2() {
            if (!datosM2 || datosM2.length === 0) {
                console.log('No hay datos de M2 para mostrar');
                return;
            }
            
            const inputDesde = document.getElementById('fechaDesdeBCRAResumen');
            const inputHasta = document.getElementById('fechaHastaBCRAResumen');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            const fechaDesde = new Date(inputDesde.value + 'T00:00:00');
            const fechaHasta = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesde > fechaHasta) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            const datosFiltrados = datosM2.filter(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha >= fechaDesde && fecha <= fechaHasta;
            });
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            const valores = datosFiltrados.map(d => d.porcentaje_pbi);
            const primero = datosFiltrados[0];
            const ultimo = datosFiltrados[datosFiltrados.length - 1];
            const promedio = (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2);
            
            let maximo = datosFiltrados[0];
            let minimo = datosFiltrados[0];
            datosFiltrados.forEach(d => {
                if (d.porcentaje_pbi > maximo.porcentaje_pbi) maximo = d;
                if (d.porcentaje_pbi < minimo.porcentaje_pbi) minimo = d;
            });
            
            const formatearFecha = (fecha) => {
                const f = stringToFechaLocal(fecha);
                return f.toLocaleDateString('es-AR', { day: 'numeric', month: 'short', year: 'numeric' }).replace('.', '');
            };
            
            document.getElementById('m2-primero').textContent = primero.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('m2-primero-fecha').textContent = formatearFecha(primero.fecha);
            document.getElementById('m2-ultimo').textContent = ultimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('m2-ultimo-fecha').textContent = formatearFecha(ultimo.fecha);
            document.getElementById('m2-promedio').textContent = promedio + '%';
            document.getElementById('m2-maximo').textContent = maximo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('m2-maximo-fecha').textContent = formatearFecha(maximo.fecha);
            document.getElementById('m2-minimo').textContent = minimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('m2-minimo-fecha').textContent = formatearFecha(minimo.fecha);
        }
        
        function inicializarSelectoresFechasM2() {
            const primeraFechaStr = datosM2[0].fecha;
            const ultimaFechaStr = datosM2[datosM2.length - 1].fecha;
            const fechaDesdeDefaultStr = '2023-12-01';
            
            const inputDesde = document.getElementById('fechaDesdeM2');
            const inputHasta = document.getElementById('fechaHastaM2');
            
            inputDesde.value = fechaDesdeDefaultStr;
            inputHasta.value = ultimaFechaStr;
            inputDesde.min = primeraFechaStr;
            inputDesde.max = ultimaFechaStr;
            inputHasta.min = primeraFechaStr;
            inputHasta.max = ultimaFechaStr;
            
            fechaDesdeM2 = stringToFechaLocal(fechaDesdeDefaultStr);
            fechaHastaM2 = stringToFechaLocal(ultimaFechaStr);
        }
        
        function filtrarDatosM2PorFechas() {
            if (!fechaDesdeM2 || !fechaHastaM2) return datosM2;
            
            let indiceDesde = datosM2.findIndex(d => stringToFechaLocal(d.fecha) >= fechaDesdeM2);
            if (indiceDesde === -1) indiceDesde = datosM2.length - 1;
            else if (indiceDesde > 0 && stringToFechaLocal(datosM2[indiceDesde].fecha) > fechaDesdeM2) indiceDesde = indiceDesde - 1;
            
            let indiceHasta = -1;
            for (let i = datosM2.length - 1; i >= 0; i--) {
                if (stringToFechaLocal(datosM2[i].fecha) <= fechaHastaM2) {
                    indiceHasta = i;
                    break;
                }
            }
            
            if (indiceHasta === -1) return [];
            return datosM2.slice(indiceDesde, indiceHasta + 1);
        }
        
        function inicializarChartM2() {
            const ctx = document.getElementById('chartM2');
            if (!ctx) return;
            const datosFiltrados = filtrarDatosM2PorFechas();
            if (datosFiltrados.length === 0) return;
            const isMobile = window.innerWidth <= 768;
            
            chartM2 = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: datosFiltrados.map(d => {
                        const fecha = stringToFechaLocal(d.fecha);
                        return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
                    }),
                    datasets: [{
                        label: 'M2 Transaccional (% PBI)',
                        data: datosFiltrados.map(d => d.porcentaje_pbi),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: isMobile ? 2 : 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#f59e0b',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 16,
                            titleFont: { size: 14, weight: '600' },
                            bodyFont: { size: 16, weight: '700' },
                            titleColor: '#94a3b8',
                            bodyColor: '#fff',
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const fecha = stringToFechaLocal(datosFiltrados[context[0].dataIndex].fecha);
                                    return fecha.toLocaleDateString('es-AR', { day: '2-digit', month: 'long', year: 'numeric' });
                                },
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + '% del PBI';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 10 : 12 },
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 9 : 11 },
                                maxRotation: isMobile ? 45 : 0,
                                minRotation: isMobile ? 45 : 0
                            }
                        }
                    }
                }
            });
        }
        
        function aplicarFiltroM2() {
            const inputDesde = document.getElementById('fechaDesdeM2');
            const inputHasta = document.getElementById('fechaHastaM2');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            fechaDesdeM2 = new Date(inputDesde.value + 'T00:00:00');
            fechaHastaM2 = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesdeM2 > fechaHastaM2) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            actualizarChartM2();
        }
        
        function actualizarChartM2() {
            if (!chartM2) return;
            const datosFiltrados = filtrarDatosM2PorFechas();
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            chartM2.data.labels = datosFiltrados.map(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
            });
            chartM2.data.datasets[0].data = datosFiltrados.map(d => d.porcentaje_pbi);
            chartM2.update();
        }
        
        // ==========================================
        // PR√âSTAMOS EN PESOS - FUNCIONES
        // ==========================================
        
        async function cargarDatosPrestPesos() {
            try {
                console.log('Cargando Pr√©stamos en Pesos desde Supabase...');
                
                datosPrestPesos = [];
                let offset = 0;
                const pageSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const { data, error } = await supabaseClient
                        .from('prestamos_pesos')
                        .select('*')
                        .order('fecha', { ascending: true })
                        .range(offset, offset + pageSize - 1);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        datosPrestPesos = datosPrestPesos.concat(data);
                        console.log(`Prest$ - P√°gina cargada: ${data.length} registros (total: ${datosPrestPesos.length})`);
                        offset += pageSize;
                        hasMore = data.length === pageSize;
                    } else {
                        hasMore = false;
                    }
                }
                
                console.log(`‚úÖ Pr√©stamos en Pesos cargados: ${datosPrestPesos.length} registros`);
                console.log('Primeros 3:', datosPrestPesos.slice(0, 3));
                console.log('√öltimos 3:', datosPrestPesos.slice(-3));
                return datosPrestPesos;
                
            } catch (error) {
                console.error('Error cargando Pr√©stamos en Pesos:', error);
                throw error;
            }
        }
        
        function aplicarFiltroResumenPrestPesos() {
            if (!datosPrestPesos || datosPrestPesos.length === 0) {
                console.log('No hay datos de Pr√©stamos en Pesos para mostrar');
                return;
            }
            
            const inputDesde = document.getElementById('fechaDesdeBCRAResumen');
            const inputHasta = document.getElementById('fechaHastaBCRAResumen');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            const fechaDesde = new Date(inputDesde.value + 'T00:00:00');
            const fechaHasta = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesde > fechaHasta) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            const datosFiltrados = datosPrestPesos.filter(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha >= fechaDesde && fecha <= fechaHasta;
            });
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            const valores = datosFiltrados.map(d => d.porcentaje_pbi);
            const primero = datosFiltrados[0];
            const ultimo = datosFiltrados[datosFiltrados.length - 1];
            const promedio = (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2);
            
            let maximo = datosFiltrados[0];
            let minimo = datosFiltrados[0];
            datosFiltrados.forEach(d => {
                if (d.porcentaje_pbi > maximo.porcentaje_pbi) maximo = d;
                if (d.porcentaje_pbi < minimo.porcentaje_pbi) minimo = d;
            });
            
            const formatearFecha = (fecha) => {
                const f = stringToFechaLocal(fecha);
                return f.toLocaleDateString('es-AR', { day: 'numeric', month: 'short', year: 'numeric' }).replace('.', '');
            };
            
            document.getElementById('pp-primero').textContent = primero.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pp-primero-fecha').textContent = formatearFecha(primero.fecha);
            document.getElementById('pp-ultimo').textContent = ultimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pp-ultimo-fecha').textContent = formatearFecha(ultimo.fecha);
            document.getElementById('pp-promedio').textContent = promedio + '%';
            document.getElementById('pp-maximo').textContent = maximo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pp-maximo-fecha').textContent = formatearFecha(maximo.fecha);
            document.getElementById('pp-minimo').textContent = minimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pp-minimo-fecha').textContent = formatearFecha(minimo.fecha);
        }
        
        function inicializarSelectoresFechasPrestPesos() {
            const primeraFechaStr = datosPrestPesos[0].fecha;
            const ultimaFechaStr = datosPrestPesos[datosPrestPesos.length - 1].fecha;
            const fechaDesdeDefaultStr = '2023-12-01';
            
            const inputDesde = document.getElementById('fechaDesdePrestPesos');
            const inputHasta = document.getElementById('fechaHastaPrestPesos');
            
            inputDesde.value = fechaDesdeDefaultStr;
            inputHasta.value = ultimaFechaStr;
            inputDesde.min = primeraFechaStr;
            inputDesde.max = ultimaFechaStr;
            inputHasta.min = primeraFechaStr;
            inputHasta.max = ultimaFechaStr;
            
            fechaDesdePrestPesos = stringToFechaLocal(fechaDesdeDefaultStr);
            fechaHastaPrestPesos = stringToFechaLocal(ultimaFechaStr);
        }
        
        function filtrarDatosPrestPesosPorFechas() {
            if (!fechaDesdePrestPesos || !fechaHastaPrestPesos) return datosPrestPesos;
            
            let indiceDesde = datosPrestPesos.findIndex(d => stringToFechaLocal(d.fecha) >= fechaDesdePrestPesos);
            if (indiceDesde === -1) indiceDesde = datosPrestPesos.length - 1;
            else if (indiceDesde > 0 && stringToFechaLocal(datosPrestPesos[indiceDesde].fecha) > fechaDesdePrestPesos) indiceDesde = indiceDesde - 1;
            
            let indiceHasta = -1;
            for (let i = datosPrestPesos.length - 1; i >= 0; i--) {
                if (stringToFechaLocal(datosPrestPesos[i].fecha) <= fechaHastaPrestPesos) {
                    indiceHasta = i;
                    break;
                }
            }
            
            if (indiceHasta === -1) return [];
            return datosPrestPesos.slice(indiceDesde, indiceHasta + 1);
        }
        
        function inicializarChartPrestPesos() {
            const ctx = document.getElementById('chartPrestPesos');
            if (!ctx) return;
            const datosFiltrados = filtrarDatosPrestPesosPorFechas();
            if (datosFiltrados.length === 0) return;
            const isMobile = window.innerWidth <= 768;
            
            chartPrestPesos = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: datosFiltrados.map(d => {
                        const fecha = stringToFechaLocal(d.fecha);
                        return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
                    }),
                    datasets: [{
                        label: 'Pr√©stamos en Pesos (% PBI)',
                        data: datosFiltrados.map(d => d.porcentaje_pbi),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: isMobile ? 2 : 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 16,
                            titleFont: { size: 14, weight: '600' },
                            bodyFont: { size: 16, weight: '700' },
                            titleColor: '#94a3b8',
                            bodyColor: '#fff',
                            borderColor: '#8b5cf6',
                            borderWidth: 2,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const fecha = stringToFechaLocal(datosFiltrados[context[0].dataIndex].fecha);
                                    return fecha.toLocaleDateString('es-AR', { day: '2-digit', month: 'long', year: 'numeric' });
                                },
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + '% del PBI';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 10 : 12 },
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 9 : 11 },
                                maxRotation: isMobile ? 45 : 0,
                                minRotation: isMobile ? 45 : 0
                            }
                        }
                    }
                }
            });
        }
        
        function aplicarFiltroPrestPesos() {
            const inputDesde = document.getElementById('fechaDesdePrestPesos');
            const inputHasta = document.getElementById('fechaHastaPrestPesos');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            fechaDesdePrestPesos = new Date(inputDesde.value + 'T00:00:00');
            fechaHastaPrestPesos = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesdePrestPesos > fechaHastaPrestPesos) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            actualizarChartPrestPesos();
        }
        
        function actualizarChartPrestPesos() {
            if (!chartPrestPesos) return;
            const datosFiltrados = filtrarDatosPrestPesosPorFechas();
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            chartPrestPesos.data.labels = datosFiltrados.map(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
            });
            chartPrestPesos.data.datasets[0].data = datosFiltrados.map(d => d.porcentaje_pbi);
            chartPrestPesos.update();
        }
        
        // ==========================================
        // PR√âSTAMOS EN D√ìLARES - FUNCIONES
        // ==========================================
        
        async function cargarDatosPrestDolares() {
            try {
                console.log('Cargando Pr√©stamos en D√≥lares desde Supabase...');
                
                datosPrestDolares = [];
                let offset = 0;
                const pageSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const { data, error } = await supabaseClient
                        .from('prestamos_dolares')
                        .select('*')
                        .order('fecha', { ascending: true })
                        .range(offset, offset + pageSize - 1);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        datosPrestDolares = datosPrestDolares.concat(data);
                        console.log(`PrestU$D - P√°gina cargada: ${data.length} registros (total: ${datosPrestDolares.length})`);
                        offset += pageSize;
                        hasMore = data.length === pageSize;
                    } else {
                        hasMore = false;
                    }
                }
                
                console.log(`‚úÖ Pr√©stamos en D√≥lares cargados: ${datosPrestDolares.length} registros`);
                console.log('Primeros 3:', datosPrestDolares.slice(0, 3));
                console.log('√öltimos 3:', datosPrestDolares.slice(-3));
                return datosPrestDolares;
                
            } catch (error) {
                console.error('Error cargando Pr√©stamos en D√≥lares:', error);
                throw error;
            }
        }
        
        function aplicarFiltroResumenPrestDolares() {
            if (!datosPrestDolares || datosPrestDolares.length === 0) {
                console.log('No hay datos de Pr√©stamos en D√≥lares para mostrar');
                return;
            }
            
            const inputDesde = document.getElementById('fechaDesdeBCRAResumen');
            const inputHasta = document.getElementById('fechaHastaBCRAResumen');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            const fechaDesde = new Date(inputDesde.value + 'T00:00:00');
            const fechaHasta = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesde > fechaHasta) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            const datosFiltrados = datosPrestDolares.filter(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha >= fechaDesde && fecha <= fechaHasta;
            });
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            const valores = datosFiltrados.map(d => d.porcentaje_pbi);
            const primero = datosFiltrados[0];
            const ultimo = datosFiltrados[datosFiltrados.length - 1];
            const promedio = (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2);
            
            let maximo = datosFiltrados[0];
            let minimo = datosFiltrados[0];
            datosFiltrados.forEach(d => {
                if (d.porcentaje_pbi > maximo.porcentaje_pbi) maximo = d;
                if (d.porcentaje_pbi < minimo.porcentaje_pbi) minimo = d;
            });
            
            const formatearFecha = (fecha) => {
                const f = stringToFechaLocal(fecha);
                return f.toLocaleDateString('es-AR', { day: 'numeric', month: 'short', year: 'numeric' }).replace('.', '');
            };
            
            document.getElementById('pd-primero').textContent = primero.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pd-primero-fecha').textContent = formatearFecha(primero.fecha);
            document.getElementById('pd-ultimo').textContent = ultimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pd-ultimo-fecha').textContent = formatearFecha(ultimo.fecha);
            document.getElementById('pd-promedio').textContent = promedio + '%';
            document.getElementById('pd-maximo').textContent = maximo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pd-maximo-fecha').textContent = formatearFecha(maximo.fecha);
            document.getElementById('pd-minimo').textContent = minimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pd-minimo-fecha').textContent = formatearFecha(minimo.fecha);
        }
        
        function inicializarSelectoresFechasPrestDolares() {
            const primeraFechaStr = datosPrestDolares[0].fecha;
            const ultimaFechaStr = datosPrestDolares[datosPrestDolares.length - 1].fecha;
            const fechaDesdeDefaultStr = '2023-12-01';
            
            const inputDesde = document.getElementById('fechaDesdePrestDolares');
            const inputHasta = document.getElementById('fechaHastaPrestDolares');
            
            inputDesde.value = fechaDesdeDefaultStr;
            inputHasta.value = ultimaFechaStr;
            inputDesde.min = primeraFechaStr;
            inputDesde.max = ultimaFechaStr;
            inputHasta.min = primeraFechaStr;
            inputHasta.max = ultimaFechaStr;
            
            fechaDesdePrestDolares = stringToFechaLocal(fechaDesdeDefaultStr);
            fechaHastaPrestDolares = stringToFechaLocal(ultimaFechaStr);
        }
        
        function filtrarDatosPrestDolaresPorFechas() {
            if (!fechaDesdePrestDolares || !fechaHastaPrestDolares) return datosPrestDolares;
            
            let indiceDesde = datosPrestDolares.findIndex(d => stringToFechaLocal(d.fecha) >= fechaDesdePrestDolares);
            if (indiceDesde === -1) indiceDesde = datosPrestDolares.length - 1;
            else if (indiceDesde > 0 && stringToFechaLocal(datosPrestDolares[indiceDesde].fecha) > fechaDesdePrestDolares) indiceDesde = indiceDesde - 1;
            
            let indiceHasta = -1;
            for (let i = datosPrestDolares.length - 1; i >= 0; i--) {
                if (stringToFechaLocal(datosPrestDolares[i].fecha) <= fechaHastaPrestDolares) {
                    indiceHasta = i;
                    break;
                }
            }
            
            if (indiceHasta === -1) return [];
            return datosPrestDolares.slice(indiceDesde, indiceHasta + 1);
        }
        
        function inicializarChartPrestDolares() {
            const ctx = document.getElementById('chartPrestDolares');
            if (!ctx) return;
            const datosFiltrados = filtrarDatosPrestDolaresPorFechas();
            if (datosFiltrados.length === 0) return;
            const isMobile = window.innerWidth <= 768;
            
            chartPrestDolares = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: datosFiltrados.map(d => {
                        const fecha = stringToFechaLocal(d.fecha);
                        return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
                    }),
                    datasets: [{
                        label: 'Pr√©stamos en D√≥lares (% PBI)',
                        data: datosFiltrados.map(d => d.porcentaje_pbi),
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        borderWidth: isMobile ? 2 : 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#06b6d4',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 16,
                            titleFont: { size: 14, weight: '600' },
                            bodyFont: { size: 16, weight: '700' },
                            titleColor: '#94a3b8',
                            bodyColor: '#fff',
                            borderColor: '#06b6d4',
                            borderWidth: 2,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const fecha = stringToFechaLocal(datosFiltrados[context[0].dataIndex].fecha);
                                    return fecha.toLocaleDateString('es-AR', { day: '2-digit', month: 'long', year: 'numeric' });
                                },
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + '% del PBI';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 10 : 12 },
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 9 : 11 },
                                maxRotation: isMobile ? 45 : 0,
                                minRotation: isMobile ? 45 : 0
                            }
                        }
                    }
                }
            });
        }
        
        function aplicarFiltroPrestDolares() {
            const inputDesde = document.getElementById('fechaDesdePrestDolares');
            const inputHasta = document.getElementById('fechaHastaPrestDolares');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            fechaDesdePrestDolares = new Date(inputDesde.value + 'T00:00:00');
            fechaHastaPrestDolares = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesdePrestDolares > fechaHastaPrestDolares) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            actualizarChartPrestDolares();
        }
        
        function actualizarChartPrestDolares() {
            if (!chartPrestDolares) return;
            const datosFiltrados = filtrarDatosPrestDolaresPorFechas();
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            chartPrestDolares.data.labels = datosFiltrados.map(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
            });
            chartPrestDolares.data.datasets[0].data = datosFiltrados.map(d => d.porcentaje_pbi);
            chartPrestDolares.update();
        }
        
        // ==========================================
        // PR√âSTAMOS TOTALES - FUNCIONES
        // ==========================================
        
        async function cargarDatosPrestTotales() {
            try {
                console.log('Cargando Pr√©stamos Totales desde Supabase...');
                
                datosPrestTotales = [];
                let offset = 0;
                const pageSize = 1000;
                let hasMore = true;
                
                while (hasMore) {
                    const { data, error } = await supabaseClient
                        .from('prestamos_totales')
                        .select('*')
                        .order('fecha', { ascending: true })
                        .range(offset, offset + pageSize - 1);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        datosPrestTotales = datosPrestTotales.concat(data);
                        console.log(`PrestTot - P√°gina cargada: ${data.length} registros (total: ${datosPrestTotales.length})`);
                        offset += pageSize;
                        hasMore = data.length === pageSize;
                    } else {
                        hasMore = false;
                    }
                }
                
                console.log(`‚úÖ Pr√©stamos Totales cargados: ${datosPrestTotales.length} registros`);
                console.log('Primeros 3:', datosPrestTotales.slice(0, 3));
                console.log('√öltimos 3:', datosPrestTotales.slice(-3));
                return datosPrestTotales;
                
            } catch (error) {
                console.error('Error cargando Pr√©stamos Totales:', error);
                throw error;
            }
        }
        
        function aplicarFiltroResumenPrestTotales() {
            if (!datosPrestTotales || datosPrestTotales.length === 0) {
                console.log('No hay datos de Pr√©stamos Totales para mostrar');
                return;
            }
            
            const inputDesde = document.getElementById('fechaDesdeBCRAResumen');
            const inputHasta = document.getElementById('fechaHastaBCRAResumen');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            const fechaDesde = new Date(inputDesde.value + 'T00:00:00');
            const fechaHasta = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesde > fechaHasta) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            const datosFiltrados = datosPrestTotales.filter(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha >= fechaDesde && fecha <= fechaHasta;
            });
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            const valores = datosFiltrados.map(d => d.porcentaje_pbi);
            const primero = datosFiltrados[0];
            const ultimo = datosFiltrados[datosFiltrados.length - 1];
            const promedio = (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2);
            
            let maximo = datosFiltrados[0];
            let minimo = datosFiltrados[0];
            datosFiltrados.forEach(d => {
                if (d.porcentaje_pbi > maximo.porcentaje_pbi) maximo = d;
                if (d.porcentaje_pbi < minimo.porcentaje_pbi) minimo = d;
            });
            
            const formatearFecha = (fecha) => {
                const f = stringToFechaLocal(fecha);
                return f.toLocaleDateString('es-AR', { day: 'numeric', month: 'short', year: 'numeric' }).replace('.', '');
            };
            
            document.getElementById('pt-primero').textContent = primero.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pt-primero-fecha').textContent = formatearFecha(primero.fecha);
            document.getElementById('pt-ultimo').textContent = ultimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pt-ultimo-fecha').textContent = formatearFecha(ultimo.fecha);
            document.getElementById('pt-promedio').textContent = promedio + '%';
            document.getElementById('pt-maximo').textContent = maximo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pt-maximo-fecha').textContent = formatearFecha(maximo.fecha);
            document.getElementById('pt-minimo').textContent = minimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('pt-minimo-fecha').textContent = formatearFecha(minimo.fecha);
        }
        
        function inicializarSelectoresFechasPrestTotales() {
            const primeraFechaStr = datosPrestTotales[0].fecha;
            const ultimaFechaStr = datosPrestTotales[datosPrestTotales.length - 1].fecha;
            const fechaDesdeDefaultStr = '2023-12-01';
            
            const inputDesde = document.getElementById('fechaDesdePrestTotales');
            const inputHasta = document.getElementById('fechaHastaPrestTotales');
            
            inputDesde.value = fechaDesdeDefaultStr;
            inputHasta.value = ultimaFechaStr;
            inputDesde.min = primeraFechaStr;
            inputDesde.max = ultimaFechaStr;
            inputHasta.min = primeraFechaStr;
            inputHasta.max = ultimaFechaStr;
            
            fechaDesdePrestTotales = stringToFechaLocal(fechaDesdeDefaultStr);
            fechaHastaPrestTotales = stringToFechaLocal(ultimaFechaStr);
        }
        
        function filtrarDatosPrestTotalesPorFechas() {
            if (!fechaDesdePrestTotales || !fechaHastaPrestTotales) return datosPrestTotales;
            
            let indiceDesde = datosPrestTotales.findIndex(d => stringToFechaLocal(d.fecha) >= fechaDesdePrestTotales);
            if (indiceDesde === -1) indiceDesde = datosPrestTotales.length - 1;
            else if (indiceDesde > 0 && stringToFechaLocal(datosPrestTotales[indiceDesde].fecha) > fechaDesdePrestTotales) indiceDesde = indiceDesde - 1;
            
            let indiceHasta = -1;
            for (let i = datosPrestTotales.length - 1; i >= 0; i--) {
                if (stringToFechaLocal(datosPrestTotales[i].fecha) <= fechaHastaPrestTotales) {
                    indiceHasta = i;
                    break;
                }
            }
            
            if (indiceHasta === -1) return [];
            return datosPrestTotales.slice(indiceDesde, indiceHasta + 1);
        }
        
        function inicializarChartPrestTotales() {
            const ctx = document.getElementById('chartPrestTotales');
            if (!ctx) return;
            const datosFiltrados = filtrarDatosPrestTotalesPorFechas();
            if (datosFiltrados.length === 0) return;
            const isMobile = window.innerWidth <= 768;
            
            chartPrestTotales = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: datosFiltrados.map(d => {
                        const fecha = stringToFechaLocal(d.fecha);
                        return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
                    }),
                    datasets: [{
                        label: 'Pr√©stamos Totales (% PBI)',
                        data: datosFiltrados.map(d => d.porcentaje_pbi),
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        borderWidth: isMobile ? 2 : 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#ec4899',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 16,
                            titleFont: { size: 14, weight: '600' },
                            bodyFont: { size: 16, weight: '700' },
                            titleColor: '#94a3b8',
                            bodyColor: '#fff',
                            borderColor: '#ec4899',
                            borderWidth: 2,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const fecha = stringToFechaLocal(datosFiltrados[context[0].dataIndex].fecha);
                                    return fecha.toLocaleDateString('es-AR', { day: '2-digit', month: 'long', year: 'numeric' });
                                },
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + '% del PBI';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 10 : 12 },
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 9 : 11 },
                                maxRotation: isMobile ? 45 : 0,
                                minRotation: isMobile ? 45 : 0
                            }
                        }
                    }
                }
            });
        }
        
        function aplicarFiltroPrestTotales() {
            const inputDesde = document.getElementById('fechaDesdePrestTotales');
            const inputHasta = document.getElementById('fechaHastaPrestTotales');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            fechaDesdePrestTotales = new Date(inputDesde.value + 'T00:00:00');
            fechaHastaPrestTotales = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesdePrestTotales > fechaHastaPrestTotales) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            actualizarChartPrestTotales();
        }
        
        function actualizarChartPrestTotales() {
            if (!chartPrestTotales) return;
            const datosFiltrados = filtrarDatosPrestTotalesPorFechas();
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            chartPrestTotales.data.labels = datosFiltrados.map(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
            });
            chartPrestTotales.data.datasets[0].data = datosFiltrados.map(d => d.porcentaje_pbi);
            chartPrestTotales.update();
        }
        
        function aplicarFiltroResumenDEP() {
            // Si no hay datos, salir silenciosamente
            if (!datosDEP || datosDEP.length === 0) {
                console.log('No hay datos de Dep√≥sitos para mostrar');
                return;
            }
            
            const inputDesde = document.getElementById('fechaDesdeBCRAResumen');
            const inputHasta = document.getElementById('fechaHastaBCRAResumen');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            const fechaDesde = new Date(inputDesde.value + 'T00:00:00');
            const fechaHasta = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesde > fechaHasta) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            const datosFiltrados = datosDEP.filter(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha >= fechaDesde && fecha <= fechaHasta;
            });
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            const valores = datosFiltrados.map(d => d.porcentaje_pbi);
            const primero = datosFiltrados[0];
            const ultimo = datosFiltrados[datosFiltrados.length - 1];
            const promedio = (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2);
            
            let maximo = datosFiltrados[0];
            let minimo = datosFiltrados[0];
            datosFiltrados.forEach(d => {
                if (d.porcentaje_pbi > maximo.porcentaje_pbi) maximo = d;
                if (d.porcentaje_pbi < minimo.porcentaje_pbi) minimo = d;
            });
            
            const formatearFecha = (fecha) => {
                const f = stringToFechaLocal(fecha);
                return f.toLocaleDateString('es-AR', { day: 'numeric', month: 'short', year: 'numeric' }).replace('.', '');
            };
            
            document.getElementById('dep-primero').textContent = primero.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('dep-primero-fecha').textContent = formatearFecha(primero.fecha);
            
            document.getElementById('dep-ultimo').textContent = ultimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('dep-ultimo-fecha').textContent = formatearFecha(ultimo.fecha);
            
            document.getElementById('dep-promedio').textContent = promedio + '%';
            
            document.getElementById('dep-maximo').textContent = maximo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('dep-maximo-fecha').textContent = formatearFecha(maximo.fecha);
            
            document.getElementById('dep-minimo').textContent = minimo.porcentaje_pbi.toFixed(2) + '%';
            document.getElementById('dep-minimo-fecha').textContent = formatearFecha(minimo.fecha);
        }
        
        function inicializarSelectoresFechasDEP() {
            // Obtener primera y √∫ltima fecha de los datos (ya son strings "YYYY-MM-DD")
            const primeraFechaStr = datosDEP[0].fecha;
            const ultimaFechaStr = datosDEP[datosDEP.length - 1].fecha;
            const fechaDesdeDefaultStr = '2023-12-01';
            
            const inputDesde = document.getElementById('fechaDesdeDEP');
            const inputHasta = document.getElementById('fechaHastaDEP');
            
            inputDesde.value = fechaDesdeDefaultStr;
            inputHasta.value = ultimaFechaStr;
            
            inputDesde.min = primeraFechaStr;
            inputDesde.max = ultimaFechaStr;
            inputHasta.min = primeraFechaStr;
            inputHasta.max = ultimaFechaStr;
            
            fechaDesdeDEP = stringToFechaLocal(fechaDesdeDefaultStr);
            fechaHastaDEP = stringToFechaLocal(ultimaFechaStr);
        }
        
        function filtrarDatosDEPPorFechas() {
            if (!fechaDesdeDEP || !fechaHastaDEP) {
                return datosDEP;
            }
            
            let indiceDesde = datosDEP.findIndex(d => stringToFechaLocal(d.fecha) >= fechaDesdeDEP);
            
            if (indiceDesde === -1) {
                indiceDesde = datosDEP.length - 1;
            } else if (indiceDesde > 0 && stringToFechaLocal(datosDEP[indiceDesde].fecha) > fechaDesdeDEP) {
                indiceDesde = indiceDesde - 1;
            }
            
            let indiceHasta = -1;
            for (let i = datosDEP.length - 1; i >= 0; i--) {
                if (stringToFechaLocal(datosDEP[i].fecha) <= fechaHastaDEP) {
                    indiceHasta = i;
                    break;
                }
            }
            
            if (indiceHasta === -1) {
                return [];
            }
            
            return datosDEP.slice(indiceDesde, indiceHasta + 1);
        }
        
        function inicializarChartDEP() {
            const ctx = document.getElementById('chartDEP');
            if (!ctx) return;
            
            const datosFiltrados = filtrarDatosDEPPorFechas();
            
            if (chartDEP) {
                chartDEP.destroy();
            }
            
            const isMobile = window.innerWidth <= 768;
            
            chartDEP = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: datosFiltrados.map(d => {
                        const fecha = stringToFechaLocal(d.fecha);
                        return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
                    }),
                    datasets: [{
                        label: 'Dep√≥sitos Totales (% PBI)',
                        data: datosFiltrados.map(d => d.porcentaje_pbi),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: isMobile ? 2 : 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 16,
                            titleFont: { size: 14, weight: '600' },
                            bodyFont: { size: 16, weight: '700' },
                            titleColor: '#94a3b8',
                            bodyColor: '#fff',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const fecha = stringToFechaLocal(datosFiltrados[context[0].dataIndex].fecha);
                                    return fecha.toLocaleDateString('es-AR', { day: '2-digit', month: 'long', year: 'numeric' });
                                },
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + '% del PBI';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 10 : 13 },
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: isMobile ? 9 : 12 },
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: isMobile ? 6 : 20
                            }
                        }
                    }
                }
            });
            
            if (isMobile) {
                const canvas = ctx;
                let touchTimeout;
                let isTouch = false;
                
                canvas.addEventListener('touchstart', function(e) {
                    clearTimeout(touchTimeout);
                    isTouch = true;
                });
                
                canvas.addEventListener('touchmove', function(e) {
                    isTouch = true;
                });
                
                canvas.addEventListener('touchend', function(e) {
                    if (!isTouch) return;
                    
                    touchTimeout = setTimeout(() => {
                        if (chartDEP && chartDEP.data && chartDEP.data.datasets[0]) {
                            chartDEP.data.datasets[0].pointRadius = 0;
                            chartDEP.data.datasets[0].pointHoverRadius = 0;
                            chartDEP.tooltip.setActiveElements([]);
                            chartDEP.setActiveElements([]);
                            chartDEP.update('none');
                            
                            setTimeout(() => {
                                if (chartDEP && chartDEP.data && chartDEP.data.datasets[0]) {
                                    chartDEP.data.datasets[0].pointRadius = 0;
                                    chartDEP.data.datasets[0].pointHoverRadius = 8;
                                }
                            }, 100);
                        }
                        isTouch = false;
                    }, 200);
                });
                
                canvas.addEventListener('touchcancel', function(e) {
                    clearTimeout(touchTimeout);
                    if (chartDEP && chartDEP.data && chartDEP.data.datasets[0]) {
                        chartDEP.data.datasets[0].pointRadius = 0;
                        chartDEP.data.datasets[0].pointHoverRadius = 0;
                        chartDEP.tooltip.setActiveElements([]);
                        chartDEP.setActiveElements([]);
                        chartDEP.update('none');
                        setTimeout(() => {
                            if (chartDEP && chartDEP.data && chartDEP.data.datasets[0]) {
                                chartDEP.data.datasets[0].pointRadius = 0;
                                chartDEP.data.datasets[0].pointHoverRadius = 8;
                            }
                        }, 100);
                    }
                    isTouch = false;
                });
            }
        }
        
        function aplicarFiltroDEP() {
            const inputDesde = document.getElementById('fechaDesdeDEP');
            const inputHasta = document.getElementById('fechaHastaDEP');
            
            if (!inputDesde.value || !inputHasta.value) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            fechaDesdeDEP = new Date(inputDesde.value + 'T00:00:00');
            fechaHastaDEP = new Date(inputHasta.value + 'T23:59:59');
            
            if (fechaDesdeDEP > fechaHastaDEP) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            
            actualizarChartDEP();
        }
        
        function actualizarChartDEP() {
            if (!chartDEP) return;
            
            const datosFiltrados = filtrarDatosDEPPorFechas();
            
            if (datosFiltrados.length === 0) {
                alert('No hay datos disponibles para el rango seleccionado');
                return;
            }
            
            chartDEP.data.labels = datosFiltrados.map(d => {
                const fecha = stringToFechaLocal(d.fecha);
                return fecha.toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }).replace('.', '');
            });
            
            chartDEP.data.datasets[0].data = datosFiltrados.map(d => d.porcentaje_pbi);
            
            chartDEP.update();
        }

        // ==========================================
        // USUARIOS Y DATOS
        // ==========================================
        const validUsers = {
            'admin': 'MECON2026!',
            'usuario': 'MECON2026!',
            'MartinVauthier': 'MECON2026!',
            'FedericoFuriase': 'MECON2026!',
            'FelipeNu√±ez': 'MECON2026!',
            'FeloBeron': 'MECON2026!',
            'CristobalCaputo': 'MECON2026!'
        };
        let chartMensual, chartInteranual, chartEmae, chartBcra;
        let chartsInitialized = false;

        const todosMeses = ['Nov 23', 'Dic 23', 'Ene 24', 'Feb 24', 'Mar 24', 'Abr 24', 'May 24', 'Jun 24', 
                            'Jul 24', 'Ago 24', 'Sep 24', 'Oct 24', 'Nov 24', 'Dic 24', 
                            'Ene 25', 'Feb 25', 'Mar 25', 'Abr 25', 'May 25', 'Jun 25', 
                            'Jul 25', 'Ago 25', 'Sep 25', 'Oct 25', 'Nov 25', 'Dic 25', 'Ene 26'];
        
        const todosInflacionMensual = [12.8, 25.5, 20.6, 13.2, 11.0, 8.8, 4.2, 4.6, 
                                       4.0, 4.2, 3.5, 2.7, 2.4, 2.7,
                                       2.2, 2.4, 3.7, 2.8, 1.5, 1.6,
                                       1.9, 1.9, 2.1, 2.3, 2.5, 2.8, 2.9];

        const todosInflacionInteranual = [160.9, 211.4, 254.2, 276.2, 287.9, 289.4, 263.4, 236.7,
                                          215.1, 209.8, 193.1, 166.5, 152.9, 117.8,
                                          84.5, 82.5, 79.0, 75.5, 67.5, 63.3,
                                          58.0, 54.2, 50.8, 47.5, 31.4, 31.5, 32.4];

        const todosEmae = [146.4, 143.3, 143.9, 143.9, 142.9, 141.0, 142.6, 143.6, 
                          147.1, 147.8, 147.7, 148.7, 150.4, 152.2, 
                          152.2, 153.4, 150.7, 152.4, 152.2, 151.5,
                          151.5, 152.5, 153.4, 152.8, 152.4, null, null];

        // Datos BCRA - Base Monetaria (en millones de pesos)
        // Fuente: Excel del BCRA - Variable ID 71 (Saldo de base monetaria)
        // Datos diarios: 1 Nov 2025 - 27 Ene 2026 (57 d√≠as h√°biles)
        let fechasBCRA = [
            '2025-11-01', '2025-11-03', '2025-11-04', '2025-11-05', '2025-11-07', '2025-11-10', '2025-11-11', '2025-11-12', '2025-11-13', '2025-11-14',
            '2025-11-17', '2025-11-18', '2025-11-19', '2025-11-20', '2025-11-25', '2025-11-26', '2025-11-27', '2025-11-28', '2025-12-01', '2025-12-01',
            '2025-12-02', '2025-12-03', '2025-12-04', '2025-12-05', '2025-12-09', '2025-12-10', '2025-12-11', '2025-12-12', '2025-12-15', '2025-12-16',
            '2025-12-17', '2025-12-18', '2025-12-19', '2025-12-22', '2025-12-23', '2025-12-26', '2025-12-29', '2025-12-30', '2026-01-01', '2026-01-02',
            '2026-01-05', '2026-01-06', '2026-01-07', '2026-01-08', '2026-01-09', '2026-01-12', '2026-01-13', '2026-01-14', '2026-01-15', '2026-01-16',
            '2026-01-19', '2026-01-20', '2026-01-21', '2026-01-22', '2026-01-23', '2026-01-26', '2026-01-27'
        ];
        
        let baseMonetaria = [
            40938039, 41437306, 40730943, 41136124, 41881861, 41632920, 40036417, 40264655, 39820024, 40285409,
            40819556, 40323072, 40314551, 40927869, 42341489, 40563401, 41009226, 40926609, 40862891, 40921357,
            39684092, 37842747, 40457720, 38933317, 40069791, 40146702, 40856240, 41173306, 41443740, 40768621,
            41112794, 40972242, 40805912, 41416844, 41853086, 42492789, 42305192, 42956965, 43446368, 42960320,
            42683047, 42682795, 43167152, 43272002, 42895272, 42938346, 43346010, 43803268, 43701459, 44102114,
            44050201, 44040732, 44265806, 44262398, 44254340, 43364675, 41880963
        ];

        let filtroMensualDesde = 0;
        let filtroMensualHasta = todosMeses.length - 1;
        let filtroInteranualDesde = 0;
        let filtroInteranualHasta = todosMeses.length - 1;
        let filtroEmaeDesde = 0;
        let filtroEmaeHasta = todosMeses.length - 2;

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');

            if (validUsers[username] && validUsers[username] === password) {
                // Resetear estado de BCRA antes de entrar
                window.bcraDataLoaded = false;
                window.bcraFileData = null;
                window.bcraFileName = null;
                window.bcraFileSource = null;
                fechasBCRA = [];
                baseMonetaria = [];
                
                // Resetear bot√≥n de descarga
                const btnDescargar = document.getElementById('btnDescargarBCRA');
                if (btnDescargar) {
                    btnDescargar.disabled = true;
                    btnDescargar.style.opacity = '0.5';
                    btnDescargar.style.cursor = 'not-allowed';
                }
                // Resetear archivo actual
                window.archivoActual = null;
                
                // Resetear textos
                const lastUpdate = document.getElementById('lastUpdate');
                if (lastUpdate) {
                    lastUpdate.textContent = 'Sin datos cargados';
                }
                
                // Guardar usuario actual
                window.currentUser = username;
                
                // Volver a la secci√≥n de IPC & EMAE
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('ipc-emaeSection').classList.add('active');
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                
                // Mostrar dashboard
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('bottomNav').classList.add('active');
                errorMessage.style.display = 'none';
                inicializarFiltros();
            } else {
                errorMessage.style.display = 'block';
            }
        }

        function logout() {
            // Resetear estado
            window.archivoActual = null;
            
            // Resetear textos
            const lastUpdate = document.getElementById('lastUpdate');
            if (lastUpdate) {
                lastUpdate.textContent = 'Sin datos cargados';
            }
            
            // Volver a la secci√≥n de IPC/EMAE
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('ipc-emaeSection').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[0].classList.add('active');
            
            // Ocultar dashboard y mostrar login
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('bottomNav').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function inicializarFiltros() {
            const selectDesde = document.getElementById('fechaDesde');
            const selectHasta = document.getElementById('fechaHasta');
            todosMeses.forEach((mes, index) => {
                selectDesde.innerHTML += `<option value="${index}">${mes}</option>`;
                selectHasta.innerHTML += `<option value="${index}">${mes}</option>`;
            });
            selectHasta.value = todosMeses.length - 1;

            const selectDesdeInt = document.getElementById('fechaDesdeInteranual');
            const selectHastaInt = document.getElementById('fechaHastaInteranual');
            todosMeses.forEach((mes, index) => {
                selectDesdeInt.innerHTML += `<option value="${index}">${mes}</option>`;
                selectHastaInt.innerHTML += `<option value="${index}">${mes}</option>`;
            });
            selectHastaInt.value = todosMeses.length - 1;

            const selectDesdeEmae = document.getElementById('fechaDesdeEmae');
            const selectHastaEmae = document.getElementById('fechaHastaEmae');
            todosMeses.forEach((mes, index) => {
                if (todosEmae[index] !== null) {
                    selectDesdeEmae.innerHTML += `<option value="${index}">${mes}</option>`;
                    selectHastaEmae.innerHTML += `<option value="${index}">${mes}</option>`;
                }
            });
            selectHastaEmae.value = todosMeses.length - 2;
        }

        function aplicarFiltroMensual() {
            filtroMensualDesde = parseInt(document.getElementById('fechaDesde').value);
            filtroMensualHasta = parseInt(document.getElementById('fechaHasta').value);
            if (filtroMensualDesde > filtroMensualHasta) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            actualizarChartMensual();
        }

        function aplicarFiltroInteranual() {
            filtroInteranualDesde = parseInt(document.getElementById('fechaDesdeInteranual').value);
            filtroInteranualHasta = parseInt(document.getElementById('fechaHastaInteranual').value);
            if (filtroInteranualDesde > filtroInteranualHasta) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            actualizarChartInteranual();
        }

        function aplicarFiltroEmae() {
            filtroEmaeDesde = parseInt(document.getElementById('fechaDesdeEmae').value);
            filtroEmaeHasta = parseInt(document.getElementById('fechaHastaEmae').value);
            if (filtroEmaeDesde > filtroEmaeHasta) {
                alert('La fecha "Desde" debe ser anterior a "Hasta"');
                return;
            }
            actualizarChartEmae();
        }

        function showSection(section) {
            // Si intenta ir a BCRA resumen, intentar cargar datos
            if (section === 'bcra') {
                cargarDatosBCRA();
                return;
            }
            
            // Si va a bcra-bm, asegurarse que los datos est√©n cargados
            if (section === 'bcra-bm') {
                if (datosBM.length === 0) {
                    alert('Primero debes cargar los datos de BCRA');
                    return;
                }
            }
            
            // Si va a bcra-depositos, inicializar
            if (section === 'bcra-depositos') {
                if (datosDEP.length === 0) {
                    alert('Primero debes cargar los datos de BCRA');
                    return;
                }
                inicializarSelectoresFechasDEP();
                inicializarChartDEP();
            }
            
            // Si va a bcra-m2, inicializar
            if (section === 'bcra-m2') {
                if (datosM2.length === 0) {
                    alert('Primero debes cargar los datos de BCRA');
                    return;
                }
                inicializarSelectoresFechasM2();
                inicializarChartM2();
            }
            
            // Si va a bcra-prestamos-pesos, inicializar
            if (section === 'bcra-prestamos-pesos') {
                if (datosPrestPesos.length === 0) {
                    alert('Primero debes cargar los datos de BCRA');
                    return;
                }
                inicializarSelectoresFechasPrestPesos();
                inicializarChartPrestPesos();
            }
            
            // Si va a bcra-prestamos-dolares, inicializar
            if (section === 'bcra-prestamos-dolares') {
                if (datosPrestDolares.length === 0) {
                    alert('Primero debes cargar los datos de BCRA');
                    return;
                }
                inicializarSelectoresFechasPrestDolares();
                inicializarChartPrestDolares();
            }
            
            // Si va a bcra-prestamos-totales, inicializar
            if (section === 'bcra-prestamos-totales') {
                if (datosPrestTotales.length === 0) {
                    alert('Primero debes cargar los datos de BCRA');
                    return;
                }
                inicializarSelectoresFechasPrestTotales();
                inicializarChartPrestTotales();
            }
            
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section + 'Section').classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const navItems = document.querySelectorAll('.nav-item');
            const sectionMap = { 
                'ipc-emae': 0, 
                'mensual': 0,  // IPC gr√°ficos activan tab IPC
                'interanual': 0,
                'emae': 0,
                'bcra': 1,
                'bcra-bm': 1,  // BCRA Base Monetaria activa tab BCRA
                'bcra-depositos': 1,  // Dep√≥sitos activa tab BCRA
                'bcra-m2': 1,  // M2 activa tab BCRA
                'bcra-prestamos-pesos': 1,  // Pr√©stamos en Pesos activa tab BCRA
                'bcra-prestamos-dolares': 1,  // Pr√©stamos en D√≥lares activa tab BCRA
                'bcra-prestamos-totales': 1  // Pr√©stamos Totales activa tab BCRA
            };
            if (sectionMap[section] !== undefined) {
                navItems[sectionMap[section]].classList.add('active');
            }
            
            if (!chartsInitialized && (section === 'mensual' || section === 'interanual' || section === 'emae' || section === 'bcra-bm' || section === 'bcra-depositos' || section === 'bcra-m2' || section === 'bcra-prestamos-pesos' || section === 'bcra-prestamos-dolares' || section === 'bcra-prestamos-totales')) {
                initCharts();
                chartsInitialized = true;
            }
            
            window.scrollTo(0, 0);
        }

        async function mostrarModalUpload() {
            const modal = document.getElementById('modalUploadBCRA');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            const currentUser = window.currentUser;
            const isAdmin = currentUser === 'admin';
            
            // Verificar si hay archivo en Supabase
            const adminFileData = await cargarDesdeSupabase();
            
            if (isAdmin) {
                // ADMIN: Puede subir archivo
                document.getElementById('opcionSubir').style.display = 'block';
                
                if (adminFileData) {
                    document.getElementById('opcionAdmin').style.display = 'block';
                    document.getElementById('infoAdmin').textContent = 
                        `Archivo: ${adminFileData.nombre} (${formatBytes(adminFileData.tama√±o)}) - Subido: ${new Date(adminFileData.fecha).toLocaleString('es-AR')}`;
                } else {
                    document.getElementById('opcionAdmin').style.display = 'none';
                }
            } else {
                // USUARIO NORMAL: Solo puede ver archivo del admin
                document.getElementById('opcionSubir').style.display = 'none';
                
                if (adminFileData) {
                    document.getElementById('opcionAdmin').style.display = 'block';
                    document.getElementById('infoAdmin').textContent = 
                        `Archivo: ${adminFileData.nombre} (${formatBytes(adminFileData.tama√±o)}) - Subido: ${new Date(adminFileData.fecha).toLocaleString('es-AR')}`;
                    
                    // Auto-cargar para usuarios
                    setTimeout(() => verArchivoAdmin(), 300);
                } else {
                    document.getElementById('opcionAdmin').style.display = 'none';
                    const status = document.getElementById('uploadStatus');
                    status.style.display = 'block';
                    status.style.background = 'rgba(239, 68, 68, 0.1)';
                    status.style.color = '#ef4444';
                    status.style.border = '1px solid #ef4444';
                    status.innerHTML = '‚ö†Ô∏è No hay archivos disponibles. Contacta al administrador.';
                }
            }
        }
        
        function cerrarModalSinCargar() {
            document.getElementById('modalUploadBCRA').style.display = 'none';
            document.body.style.overflow = 'auto';
            // Volver a la secci√≥n IPC & EMAE
            showSection('ipc-emae');
        }
        
        function cerrarModalUpload() {
            const modal = document.getElementById('modalUploadBCRA');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Mostrar secci√≥n BCRA
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('bcraSection').classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const navItems = document.querySelectorAll('.nav-item');
            navItems[1].classList.add('active'); // BCRA es √≠ndice 1 ahora
            
            // Actualizar visor si hay archivo cargado
            if (window.archivoActual) {
                setTimeout(() => mostrarArchivo(window.archivoActual), 100);
            }
            
            window.scrollTo(0, 0);
        }
        
        function usarDatosEjemplo() {
            window.bcraDataLoaded = true;
            document.getElementById('btnContinuar').disabled = false;
            document.getElementById('btnContinuar').style.opacity = '1';
            document.getElementById('btnContinuar').style.cursor = 'pointer';
            
            const status = document.getElementById('uploadStatus');
            status.style.display = 'block';
            status.style.background = 'rgba(34, 197, 94, 0.1)';
            status.style.color = '#22c55e';
            status.style.border = '1px solid #22c55e';
            status.innerHTML = '‚úÖ Usando datos de ejemplo (1 Nov 2025 - 27 Ene 2026)';
        }

        // ==========================================
        // FUNCIONES SIMPLIFICADAS (SIN C√ìDIGOS)
        // ==========================================

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function procesarArchivo(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const status = document.getElementById('uploadStatus');
            status.style.display = 'block';
            status.style.background = 'rgba(59, 130, 246, 0.1)';
            status.style.color = '#3b82f6';
            status.style.border = '1px solid #3b82f6';
            status.innerHTML = '‚è≥ Subiendo archivo...';
            
            // Detectar si es Excel del BCRA
            const esExcelBCRA = file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xlsm');
            
            if (esExcelBCRA) {
                // Procesar Excel del BCRA
                status.innerHTML = '‚è≥ Procesando Excel del BCRA...';
                
                procesarExcelBCRA(file)
                    .then(resultado => {
                        status.style.background = 'rgba(34, 197, 94, 0.1)';
                        status.style.color = '#22c55e';
                        status.style.border = '1px solid #22c55e';
                        status.innerHTML = `‚úÖ Excel procesado: ${resultado.base_monetaria} BM + ${resultado.m2_transaccional} M2 + ${resultado.depositos} DEP + ${resultado.prestamos_pesos} Prest$ + ${resultado.prestamos_dolares} PrestU$D + ${resultado.prestamos_totales} PrestTot guardados üåê`;
                        
                        // Cerrar modal y mostrar dashboard BCRA
                        setTimeout(() => {
                            cerrarModalUpload();
                            mostrarDashboardBCRA();
                        }, 1500);
                    })
                    .catch(error => {
                        status.style.background = 'rgba(239, 68, 68, 0.1)';
                        status.style.color = '#ef4444';
                        status.style.border = '1px solid #ef4444';
                        status.innerHTML = `‚ùå Error: ${error.message}`;
                        console.error('Error:', error);
                    });
                
                return;
            }
            
            // C√≥digo original para otros archivos
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const fileData = {
                    nombre: file.name,
                    tipo: file.type,
                    tama√±o: file.size,
                    contenido: e.target.result,
                    fecha: new Date().toISOString(),
                    subidoPor: window.currentUser
                };
                
                // Guardar en Supabase si es admin
                if (window.currentUser === 'admin') {
                    status.innerHTML = '‚è≥ Guardando en la nube...';
                    
                    try {
                        await guardarEnSupabase(fileData);
                        console.log('‚úÖ Archivo guardado en Supabase para todos los dispositivos');
                    } catch (error) {
                        status.style.background = 'rgba(239, 68, 68, 0.1)';
                        status.style.color = '#ef4444';
                        status.style.border = '1px solid #ef4444';
                        status.innerHTML = `‚ùå Error al guardar: ${error.message}`;
                        console.error('Error detallado:', error);
                        return;
                    }
                }
                
                // Guardar en memoria para este usuario
                window.archivoActual = fileData;
                
                // Mostrar √©xito
                status.style.background = 'rgba(34, 197, 94, 0.1)';
                status.style.color = '#22c55e';
                status.style.border = '1px solid #22c55e';
                status.innerHTML = `‚úÖ Archivo subido: ${file.name} (${formatBytes(file.size)})`;
                
                if (window.currentUser === 'admin') {
                    status.innerHTML += ' - Guardado para todos los dispositivos üåê';
                }
                
                // Habilitar bot√≥n continuar
                document.getElementById('btnContinuar').disabled = false;
                document.getElementById('btnContinuar').style.opacity = '1';
                document.getElementById('btnContinuar').style.cursor = 'pointer';
            };
            
            reader.readAsDataURL(file);
        }
        
        async function verArchivoAdmin() {
            const status = document.getElementById('uploadStatus');
            status.style.display = 'block';
            status.style.background = 'rgba(59, 130, 246, 0.1)';
            status.style.color = '#3b82f6';
            status.style.border = '1px solid #3b82f6';
            status.innerHTML = '‚è≥ Cargando desde la nube...';
            
            const fileData = await cargarDesdeSupabase();
            
            if (!fileData) {
                status.style.background = 'rgba(239, 68, 68, 0.1)';
                status.style.color = '#ef4444';
                status.style.border = '1px solid #ef4444';
                status.innerHTML = '‚ùå No hay archivos del administrador';
                return;
            }
            
            window.archivoActual = fileData;
            
            // Mostrar √©xito en el modal
            status.style.background = 'rgba(34, 197, 94, 0.1)';
            status.style.color = '#22c55e';
            status.style.border = '1px solid #22c55e';
            status.innerHTML = `‚úÖ Archivo del admin: ${fileData.nombre} (${formatBytes(fileData.tama√±o)})`;
            
            // Habilitar bot√≥n continuar
            document.getElementById('btnContinuar').disabled = false;
            document.getElementById('btnContinuar').style.opacity = '1';
            document.getElementById('btnContinuar').style.cursor = 'pointer';
        }
        
        function mostrarArchivo(fileData) {
            const visor = document.getElementById('visorArchivo');
            const lastUpdate = document.getElementById('lastUpdate');
            
            if (!visor) {
                console.error('visorArchivo no encontrado');
                return;
            }
            
            if (lastUpdate) {
                lastUpdate.textContent = `Subido por ${fileData.subidoPor} - ${new Date(fileData.fecha).toLocaleString('es-AR')}`;
            }
            
            // Determinar tipo de archivo y mostrar
            if (fileData.tipo.startsWith('image/')) {
                // Es una imagen
                visor.innerHTML = `
                    <img src="${fileData.contenido}" style="max-width: 100%; max-height: 500px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);" />
                    <p style="color: #94a3b8; margin: 16px 0 0 0; text-align: center; font-size: 14px;">${fileData.nombre}</p>
                    <button onclick="descargarArchivo()" style="margin-top: 16px; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üì• Descargar
                    </button>
                `;
            } else {
                // Otro tipo de archivo
                const emoji = fileData.tipo.includes('pdf') ? 'üìÑ' : 
                             fileData.tipo.includes('sheet') || fileData.tipo.includes('excel') ? 'üìä' : 
                             fileData.tipo.includes('word') || fileData.tipo.includes('document') ? 'üìù' : 
                             fileData.tipo.includes('zip') || fileData.tipo.includes('rar') ? 'üì¶' :
                             fileData.tipo.includes('video') ? 'üé•' : 'üìÅ';
                
                visor.innerHTML = `
                    <div style="font-size: 64px; margin-bottom: 20px;">${emoji}</div>
                    <h3 style="color: white; margin: 0 0 12px 0; font-size: 24px;">${fileData.nombre}</h3>
                    <p style="color: #94a3b8; margin: 0 0 24px 0;">${formatBytes(fileData.tama√±o)}</p>
                    <button onclick="descargarArchivo()" style="padding: 16px 32px; background: #22c55e; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span>üì•</span>
                        <span>Descargar</span>
                    </button>
                `;
            }
        }
        
        function descargarArchivo() {
            if (!window.archivoActual) {
                alert('No hay archivo cargado');
                return;
            }
            
            const link = document.createElement('a');
            link.href = window.archivoActual.contenido;
            link.download = window.archivoActual.nombre;
            link.click();
        }

        // Drag and drop
        window.addEventListener('load', () => {
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#60a5fa';
                    dropZone.style.background = 'rgba(59, 130, 246, 0.2)';
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.borderColor = '#3b82f6';
                    dropZone.style.background = 'rgba(59, 130, 246, 0.1)';
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#3b82f6';
                    dropZone.style.background = 'rgba(59, 130, 246, 0.1)';
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        document.getElementById('fileInput').files = files;
                        procesarExcelBCRA({ target: { files: files } });
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });

        async function descargarExcel() {
            // Detectar qu√© secci√≥n est√° activa
            const seccionActiva = document.querySelector('.section.active');
            const idSeccion = seccionActiva ? seccionActiva.id : 'ipc-emaeSection';
            
            // Si est√° en cualquier secci√≥n de BCRA, descargar Excel de BCRA
            if (idSeccion === 'bcraSection' || idSeccion.startsWith('bcra-')) {
                await descargarExcelBCRA();
                return;
            }
            
            // Si est√° en IPC/EMAE, descargar Excel de IPC
            const btn = event.target.closest('.btn-primary');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span><span>Generando...</span>';
            
            try {
                if (typeof ExcelJS === 'undefined') {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js');
                }
                
                const workbook = new ExcelJS.Workbook();
                const ws = workbook.addWorksheet('Datos Completos');
                ws.addRow(['Mes', 'Inflaci√≥n Mensual (%)', 'Inflaci√≥n Interanual (%)', 'EMAE Desest. (base 2004=100)']);
                for (let i = 0; i < todosMeses.length; i++) {
                    ws.addRow([todosMeses[i], todosInflacionMensual[i], todosInflacionInteranual[i], todosEmae[i]]);
                }
                formatWorksheet(ws);
                
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'inflacion_argentina_2023-2025.xlsx';
                a.click();
                window.URL.revokeObjectURL(url);
                
                btn.innerHTML = '<span>‚úÖ</span><span>Descargado!</span>';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Error:', error);
                btn.innerHTML = '<span>‚ùå</span><span>Error</span>';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        async function descargarExcelBCRA() {
            const btn = event.target.closest('.btn-primary');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span><span>Generando...</span>';
            
            try {
                if (datosBM.length === 0) {
                    alert('No hay datos de Base Monetaria cargados');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                if (typeof ExcelJS === 'undefined') {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js');
                }
                
                const workbook = new ExcelJS.Workbook();
                const ws = workbook.addWorksheet('Base Monetaria');
                
                // Headers
                ws.addRow(['Fecha', 'Base Monetaria (millones $)', 'PBI (millones $)', '% PBI']);
                
                // Data
                for (const dato of datosBM) {
                    // Parsear fecha correctamente (dato.fecha es "YYYY-MM-DD")
                    const [year, month, day] = dato.fecha.split('-');
                    const fecha = new Date(parseInt(year), parseInt(month) - 1, parseInt(day), 12, 0, 0);
                    const fechaStr = fecha.toLocaleDateString('es-AR');
                    
                    // Obtener PBI correspondiente
                    const pbi = obtenerPBI(fecha);
                    
                    ws.addRow([
                        fechaStr,
                        dato.valor,
                        pbi,
                        dato.porcentaje_pbi
                    ]);
                }
                
                // Formato
                const headerRow = ws.getRow(1);
                headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF3b82f6' } };
                headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
                
                ws.getColumn(1).width = 12;
                ws.getColumn(2).width = 28;
                ws.getColumn(3).width = 20;
                ws.getColumn(4).width = 12;
                
                // Formatear n√∫meros
                for (let i = 2; i <= ws.rowCount; i++) {
                    ws.getCell(i, 2).numFmt = '#,##0'; // Base Monetaria
                    ws.getCell(i, 2).alignment = { horizontal: 'right' };
                    
                    ws.getCell(i, 3).numFmt = '#,##0'; // PBI
                    ws.getCell(i, 3).alignment = { horizontal: 'right' };
                    
                    ws.getCell(i, 4).numFmt = '0.00"%"'; // % PBI
                    ws.getCell(i, 4).alignment = { horizontal: 'center' };
                }
                
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                const fechaActual = new Date().toISOString().split('T')[0];
                a.download = `base_monetaria_${fechaActual}.xlsx`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                btn.innerHTML = '<span>‚úÖ</span><span>Descargado!</span>';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Error:', error);
                btn.innerHTML = '<span>‚ùå</span><span>Error</span>';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        function formatWorksheet(worksheet) {
            const headerRow = worksheet.getRow(1);
            headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0f172a' } };
            headerRow.alignment = { horizontal: 'center', vertical: 'middle' };
            worksheet.getColumn(1).width = 12;
            worksheet.getColumn(2).width = 24;
            worksheet.getColumn(3).width = 26;
            worksheet.getColumn(4).width = 30;
            for (let i = 2; i <= worksheet.rowCount; i++) {
                for (let j = 2; j <= 4; j++) {
                    worksheet.getCell(i, j).numFmt = '0.0';
                    worksheet.getCell(i, j).alignment = { horizontal: 'center' };
                }
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function initCharts() {
            Chart.defaults.color = '#cbd5e1';
            Chart.defaults.font.family = "'Inter', sans-serif";
            
            crearChartMensual();
            crearChartInteranual();
            crearChartEmae();
        }

        function crearChartMensual() {
            const meses = todosMeses.slice(filtroMensualDesde, filtroMensualHasta + 1);
            const inflacion = todosInflacionMensual.slice(filtroMensualDesde, filtroMensualHasta + 1);
            const emae = todosEmae.slice(filtroMensualDesde, filtroMensualHasta + 1);

            const ctx = document.getElementById('inflacionMensualChart').getContext('2d');
            if (chartMensual) chartMensual.destroy();
            
            chartMensual = new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'Inflaci√≥n Mensual (%)',
                        data: inflacion,
                        backgroundColor: function(context) {
                            const gradient = context.chart.ctx.createLinearGradient(0, 0, 0, 400);
                            gradient.addColorStop(0, '#3b82f6');
                            gradient.addColorStop(1, '#1e40af');
                            return gradient;
                        },
                        borderRadius: 6,
                        borderSkipped: false,
                        yAxisID: 'y',
                        order: 2
                    },
                    {
                        label: 'EMAE Desest. (base 2004=100)',
                        data: emae,
                        type: 'line',
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        yAxisID: 'y1',
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: null },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#cbd5e1',
                                font: { size: 13, weight: '600' },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: { enabled: false },
                        datalabels: {
                            display: function(context) {
                                const datasetIndex = context.datasetIndex;
                                const dataIndex = context.dataIndex;
                                
                                // Para dataset 0 (inflaci√≥n), mostrar TODAS
                                if (datasetIndex === 0) {
                                    return true;
                                }
                                
                                // Para dataset 1 (EMAE), solo primera y √∫ltima v√°lida
                                if (datasetIndex === 1) {
                                    const data = context.dataset.data;
                                    if (!data[dataIndex] || data[dataIndex] === null) return false;
                                    
                                    // Encontrar primer y √∫ltimo √≠ndice v√°lido
                                    let firstValid = -1;
                                    let lastValid = -1;
                                    for (let i = 0; i < data.length; i++) {
                                        if (data[i] !== null && data[i] !== undefined) {
                                            if (firstValid === -1) firstValid = i;
                                            lastValid = i;
                                        }
                                    }
                                    
                                    return dataIndex === firstValid || dataIndex === lastValid;
                                }
                                
                                return false;
                            },
                            anchor: function(context) {
                                // Inflaci√≥n: arriba de las barras
                                // EMAE: abajo de la l√≠nea
                                return context.datasetIndex === 0 ? 'end' : 'end';
                            },
                            align: function(context) {
                                // Inflaci√≥n: alineado arriba
                                // EMAE: alineado abajo
                                return context.datasetIndex === 0 ? 'end' : 'bottom';
                            },
                            rotation: function(context) {
                                // Inflaci√≥n: vertical (-90 grados)
                                // EMAE: horizontal (0 grados)
                                return context.datasetIndex === 0 ? -90 : 0;
                            },
                            offset: function(context) {
                                // Inflaci√≥n: offset peque√±o
                                // EMAE: offset mayor para separar de la l√≠nea
                                return context.datasetIndex === 0 ? 2 : 8;
                            },
                            clip: false,
                            font: { 
                                family: 'Inter', 
                                size: 10, 
                                weight: 'bold' 
                            },
                            color: function(context) {
                                return context.datasetIndex === 0 ? '#ffffff' : '#10b981';
                            },
                            formatter: function(value, context) {
                                if (value === null || value === undefined) return '';
                                if (context.datasetIndex === 0) {
                                    return value + '%';
                                }
                                return value.toFixed(1);
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            display: false,
                            grid: { display: false }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            display: false,
                            min: 140,
                            max: 155,
                            grid: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function crearChartInteranual() {
            const meses = todosMeses.slice(filtroInteranualDesde, filtroInteranualHasta + 1);
            const interanual = todosInflacionInteranual.slice(filtroInteranualDesde, filtroInteranualHasta + 1);

            const ctx = document.getElementById('inflacionInteranualChart').getContext('2d');
            if (chartInteranual) chartInteranual.destroy();
            
            chartInteranual = new Chart(ctx, {
                type: 'line',
                plugins: [ChartDataLabels],
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'Inflaci√≥n Interanual (%)',
                        data: interanual,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: function(context) {
                            const dataIndex = context.dataIndex;
                            const data = context.dataset.data;
                            const totalPoints = data.length;
                            
                            // Mostrar punto solo donde hay etiqueta
                            if (dataIndex === 0 || dataIndex === totalPoints - 1) return 5;
                            
                            // Valor m√°ximo
                            const maxValue = Math.max(...data);
                            if (data[dataIndex] === maxValue) return 5;
                            
                            // Valor m√≠nimo
                            const minValue = Math.min(...data);
                            if (data[dataIndex] === minValue) return 5;
                            
                            return 0; // Sin punto para el resto
                        },
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: null },
                    layout: {
                        padding: {
                            top: 55,
                            right: 20,
                            bottom: 10,
                            left: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: { enabled: false },
                        datalabels: {
                            display: function(context) {
                                const dataIndex = context.dataIndex;
                                const data = context.dataset.data;
                                const totalPoints = data.length;
                                
                                // Primer dato
                                if (dataIndex === 0) return true;
                                
                                // √öltimo dato
                                if (dataIndex === totalPoints - 1) return true;
                                
                                // Valor m√°ximo
                                const maxValue = Math.max(...data);
                                if (data[dataIndex] === maxValue) return true;
                                
                                return false;
                            },
                            anchor: 'end',
                            align: 'top',
                            offset: 6,
                            clip: false,
                            font: { 
                                family: 'Inter', 
                                size: 11, 
                                weight: 'bold' 
                            },
                            color: '#ffffff',
                            formatter: function(value) { 
                                if (value === null || value === undefined) return '';
                                return value + '%'; 
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            display: false,
                            grid: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function crearChartEmae() {
            const meses = todosMeses.slice(filtroEmaeDesde, filtroEmaeHasta + 1);
            const emae = todosEmae.slice(filtroEmaeDesde, filtroEmaeHasta + 1);

            const ctx = document.getElementById('emaeChart').getContext('2d');
            if (chartEmae) chartEmae.destroy();
            
            chartEmae = new Chart(ctx, {
                type: 'line',
                plugins: [ChartDataLabels],
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'EMAE Desestacionalizado (base 2004=100)',
                        data: emae,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: function(context) {
                            const dataIndex = context.dataIndex;
                            const data = context.dataset.data;
                            const value = data[dataIndex];
                            
                            // No mostrar si es null
                            if (value === null || value === undefined) return 0;
                            
                            // Primer dato v√°lido
                            if (dataIndex === 0) return 5;
                            
                            // Encontrar el √∫ltimo √≠ndice v√°lido
                            let lastValidIndex = -1;
                            for (let i = data.length - 1; i >= 0; i--) {
                                if (data[i] !== null && data[i] !== undefined) {
                                    lastValidIndex = i;
                                    break;
                                }
                            }
                            if (dataIndex === lastValidIndex) return 5;
                            
                            // Valor m√°ximo
                            const validData = data.filter(v => v !== null && v !== undefined);
                            const maxValue = Math.max(...validData);
                            if (value === maxValue) return 5;
                            
                            // Valor m√≠nimo
                            const minValue = Math.min(...validData);
                            if (value === minValue) return 5;
                            
                            return 0; // Sin punto para el resto
                        },
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: null },
                    layout: {
                        padding: {
                            top: 30,
                            right: 20,
                            bottom: 10,
                            left: 35
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: { enabled: false },
                        datalabels: {
                            display: function(context) {
                                const dataIndex = context.dataIndex;
                                const data = context.dataset.data;
                                const value = data[dataIndex];
                                
                                // No mostrar si es null
                                if (value === null || value === undefined) return false;
                                
                                // Primer dato v√°lido
                                if (dataIndex === 0) return true;
                                
                                // Encontrar el √∫ltimo √≠ndice v√°lido
                                let lastValid = -1;
                                for (let i = 0; i < data.length; i++) {
                                    if (data[i] !== null && data[i] !== undefined) {
                                        lastValid = i;
                                    }
                                }
                                if (dataIndex === lastValid) return true;
                                
                                // Valor m√°ximo (solo considerar valores no-null)
                                const validValues = data.filter(v => v !== null && v !== undefined);
                                const maxValue = Math.max(...validValues);
                                const minValue = Math.min(...validValues);
                                if (value === maxValue) return true;
                                if (value === minValue) return true;
                                
                                return false;
                            },
                            anchor: 'end',
                            align: 'top',
                            offset: 6,
                            clip: false,
                            font: { 
                                family: 'Inter', 
                                size: 11, 
                                weight: 'bold' 
                            },
                            color: '#ffffff',
                            formatter: function(value) {
                                if (value === null || value === undefined) return '';
                                return value.toFixed(1);
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            display: false,
                            min: 140,
                            max: 155,
                            grid: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function actualizarChartMensual() {
            crearChartMensual();
        }

        function actualizarChartInteranual() {
            crearChartInteranual();
        }

        function actualizarChartEmae() {
            crearChartEmae();
        }

        function crearChartBCRA() {
            const ctx = document.getElementById('bcraChart').getContext('2d');
            if (chartBcra) chartBcra.destroy();
            
            // Formatear fechas para mostrar (mostrar cada 7 d√≠as para legibilidad)
            const labelsFormateados = fechasBCRA.map((fecha, index) => {
                // Mostrar cada 7 d√≠as + primero y √∫ltimo
                if (index === 0 || index === fechasBCRA.length - 1 || index % 7 === 0) {
                    const d = new Date(fecha);
                    return `${d.getDate()}/${d.getMonth() + 1}`;
                }
                return '';
            });
            
            chartBcra = new Chart(ctx, {
                type: 'line',
                plugins: [ChartDataLabels],
                data: {
                    labels: labelsFormateados,
                    datasets: [{
                        label: 'Base Monetaria (millones $)',
                        data: baseMonetaria,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: function(context) {
                            const index = context.dataIndex;
                            // Mostrar puntos cada 7 d√≠as + primero y √∫ltimo
                            if (index === 0 || index === baseMonetaria.length - 1 || index % 7 === 0) {
                                return 5;
                            }
                            return 0;
                        },
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: null },
                    layout: {
                        padding: {
                            top: 30,
                            right: 20,
                            bottom: 10,
                            left: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#cbd5e1',
                                font: { size: 13, weight: '600' },
                                padding: 20
                            }
                        },
                        tooltip: { enabled: false },
                        datalabels: {
                            display: function(context) {
                                const dataIndex = context.dataIndex;
                                const data = context.dataset.data;
                                const totalPoints = data.length;
                                
                                // Primer dato
                                if (dataIndex === 0) return true;
                                
                                // √öltimo dato
                                if (dataIndex === totalPoints - 1) return true;
                                
                                // Valor m√°ximo
                                const maxValue = Math.max(...data);
                                if (data[dataIndex] === maxValue) return true;
                                
                                return false;
                            },
                            anchor: 'end',
                            align: 'top',
                            offset: 6,
                            clip: false,
                            font: { 
                                family: 'Inter', 
                                size: 11, 
                                weight: 'bold' 
                            },
                            color: '#ffffff',
                            formatter: function(value) {
                                if (value === null || value === undefined) return '';
                                // Formatear en billones
                                const billones = (value / 1000000).toFixed(1);
                                return billones + 'B';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            display: false,
                            grid: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

    </script>
</body>
</html>
